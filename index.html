<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Notes on studying kaggle.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Notes on Kaggle</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://necromuralist.github.io/Kaggle-Competitions/">
<link rel="next" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script><link rel="prefetch" href="posts/data-leakages/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://necromuralist.github.io/Kaggle-Competitions/">

                <span id="blog-title">Notes on Kaggle</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="active">
<a href=".">The Cloistered Monkey <span class="sr-only">(active)</span></a>
                </li>
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- Google custom search --><form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="form-group">
<input type="text" name="q" class="form-control" placeholder="Search">
</div>
<button type="submit" class="btn btn-primary">
	<span class="glyphicon glyphicon-search"></span>
</button>
<input type="hidden" name="sitesearch" value="https://necromuralist.github.io/Kaggle-Competitions/">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/data-leakages/" class="u-url">Data Leakages</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/data-leakages/" rel="bookmark"><time class="published dt-published" datetime="2018-09-08T18:31:29-07:00" title="2018-09-08 18:31">2018-09-08 18:31</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/data-leakages/#org8db2b91">Introduction</a></li>
<li><a href="posts/data-leakages/#orgfbf2705">Imports</a></li>
<li><a href="posts/data-leakages/#org322bdd6">Helpers</a></li>
<li><a href="posts/data-leakages/#org17f7c97">Load the data</a></li>
<li><a href="posts/data-leakages/#org386dd7a">EDA and Leakage Intuition</a></li>
<li><a href="posts/data-leakages/#org3b1b5b9">Building a magic feature</a></li>
<li><a href="posts/data-leakages/#orgdf0e4e8">Bonus</a></li>
<li><a href="posts/data-leakages/#org4c6f2ee">What does it all mean then?</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8db2b91" class="outline-2">
<h2 id="org8db2b91">Introduction</h2>
<div class="outline-text-2" id="text-org8db2b91">
<p>
In this programming assignment we will illustrate a very severe data leakage, of the sort that can often be found in competitions. The task is to score the pairs of objects, i.e. predict <i>1</i> if two objects belong to the same class and <i>0</i> otherwise. 
</p>

<p>
The data in this assignment is taken from a real competition, and  <b>we will not use the training set at all</b> and still achieve an accuracy score of almost 100% - just by exploiting the leakage.
</p>
</div>
</div>

<div id="outline-container-orgfbf2705" class="outline-2">
<h2 id="orgfbf2705">Imports</h2>
<div class="outline-text-2" id="text-orgfbf2705">
<p>
During the importing of pandas (or scipy) you get a warning about a potential binary incompatibility. According to <a href="https://stackoverflow.com/questions/40845304/runtimewarning-numpy-dtype-size-changed-may-indicate-binary-incompatibility">Stack Overflow</a> you can safely ignore this, so we'll use <a href="https://docs.python.org/3/library/warnings.html">warnings</a> to suppress the messages, just so it doesn't keep bringing them up everytime I run this notebook.
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">"numpy.dtype size changed"</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">"numpy.ufunc size changed"</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># python standard library</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">"whitegrid"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div id="outline-container-org322bdd6" class="outline-2">
<h2 id="org322bdd6">Helpers</h2>
<div class="outline-text-2" id="text-org322bdd6">
</div>
<div id="outline-container-orgbd43ef5" class="outline-3">
<h3 id="orgbd43ef5">Paths</h3>
<div class="outline-text-3" id="text-orgbd43ef5">
<p>
Since I'm doing this as posts in nikola, but I'm trying to keep all non-post files outside of the <code>posts</code> folder, I'm going to use a class to keep the paths to the output (submission) files straight.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Paths</span><span class="p">:</span>
    <span class="sd">"""Helper to put submission files in the right folder"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_submissions</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_test_set</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""The path to the data set"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="s2">"../data/"</span>
	    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""Path to the submissions"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submissions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_submissions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">"submissions/"</span><span class="p">)</span>
	    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_submissions</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_submissions</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submissions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">test_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""path to the test-set data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_set</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_test_set</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">"test_pairs.csv"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_set</span>

    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
	<span class="sd">"""Add the filename to the path</span>

<span class="sd">	Args:</span>
<span class="sd">	 filename (str): name to add to the submissions folder</span>

<span class="sd">	Returns:</span>
<span class="sd">	 str: path to the file in the submissions folder</span>
<span class="sd">	"""</span>
	<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submissions</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div id="outline-container-orgc38f5eb" class="outline-3">
<h3 id="orgc38f5eb">Data</h3>
<div class="outline-text-3" id="text-orgc38f5eb">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestSet</span><span class="p">:</span>
    <span class="sd">"""Loads the test-set data</span>

<span class="sd">    Args:</span>
<span class="sd">     paths: object with the path to the test-set</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="n">Paths</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="p">()</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""the test-set data</span>

<span class="sd">	Returns:</span>
<span class="sd">	 `pandas.DataFrame`: the test-set data</span>
<span class="sd">	"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">test_set</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</div>
</div>
<div id="outline-container-org17f7c97" class="outline-2">
<h2 id="org17f7c97">Load the data</h2>
<div class="outline-text-2" id="text-org17f7c97">
<p>
Let's load the test data. Note that we don't have any training data here, just test data. Moreover, <i>we will not use any features of the test set</i>. All we need to solve this task is the file with the indices for the pairs that we need to compare.
</p>

<p>
Let's load the data with the test indices.
</p>

<div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">TestSet</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="k">print</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>

<pre class="example">
   pairId  FirstId  SecondId
0       0     1427      8053
1       1    17044      7681
2       2    19237     20966
3       3     8005     20765
4       4    16837       599
5       5     3657     12504
6       6     2836      7582
7       7     6136      6111
8       8    23295      9817
9       9     6621      7672
</pre>


<p>
We don't know what the data represents in this case, but you can give them an arbitrary meaning. You could, for example, think that there is a test dataset of images, and each image is assigned a unique `ID` from \(0\) to \(N-1\) (N – is the number of images). In the dataframe above <code>FirstId</code> and <code>SecondId</code> point to these IDs and define pairs that we should compare: e.g. <i>Do both images in the pair belong to the same class or not?</i> So, for example for the first row: if images with `ID=1427` and `ID=8053` belong to the same class, we should predict \(1\) and \(0\) if they don't. 
</p>

<p>
But in our case we don't really care about the images, and how exactly we compare the images (as long as the output is binary).  
</p>

<p>
<b><b>We suggest you to try to solve the puzzle yourself first.</b></b> You need to submit a `.csv` file with columns `pairId` and `Prediction` to the grader. The number of submissions allowed is made pretty huge to let you explore the data without worries. The returned score should be very close to \(1\).
</p>

<div class="highlight"><pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"First ID vs Second ID"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"First ID"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Second ID"</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">FirstId</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">SecondId</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="posts/data-leakages/first_vs_second.png" alt="first_vs_second.png"></p>
</div>

<p>
So this doesn't appear to be a randomized data set. The first half of the Second IDs seem to be completely paired with the entire set of first IDs, while the second half of the second IDs creates some kind of strange diagonal pattern, except for the highest Second IDs which are once again completely matched with the First IDs.
</p>
</div>
</div>

<div id="outline-container-org386dd7a" class="outline-2">
<h2 id="org386dd7a">EDA and Leakage Intuition</h2>
<div class="outline-text-2" id="text-org386dd7a">
<p>
As we already know, the key to discovering data leakages is careful Exploratory Data Analysis (EDA). So let's start our work with some basic data exploration and build an intuition about the leakage.
</p>

<p>
First, check, how many different <i>id</i>'s are there: concatenate <i>FirstId</i> and <i>SecondId</i> and print the number of unique elements. Also print the minimum and maximum value for that vector.
</p>

<div class="highlight"><pre><span></span><span class="n">smashed</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">FirstId</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="o">+</span> <span class="s1">','</span> <span class="o">+</span> <span class="n">test</span><span class="o">.</span><span class="n">SecondId</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">smashed</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>

<pre class="example">
0      1427,8053
1     17044,7681
2    19237,20966
3     8005,20765
4      16837,599
dtype: object

</pre>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"|Unique Pairs| {}|"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smashed</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|Total Pairs| {}|"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|Lowest Valued Pair (ASCII)| ({})|"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smashed</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"|Highest Valued Pair| ({})|"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smashed</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-left">
<col class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-left">Unique Pairs</td>
<td class="org-right">368538</td>
</tr>
<tr>
<td class="org-left">Total Pairs</td>
<td class="org-right">368550</td>
</tr>
<tr>
<td class="org-left">Lowest Valued Pair (ASCII)</td>
<td class="org-right">(0,10552)</td>
</tr>
<tr>
<td class="org-left">Highest Valued Pair</td>
<td class="org-right">(9999,8996)</td>
</tr>
</tbody>
</table>
<p>
and then print how many pairs we need to classify (it is basically the number of rows in the test set)
</p>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">smashed</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
</pre></div>

<pre class="example">
368550
12

</pre>


<p>
Now print, how many distinct pairs it would be possible to create out of all "images" in the dataset?   
</p>

<div class="highlight"><pre><span></span><span class="n">catted</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">test</span><span class="o">.</span><span class="n">FirstId</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">SecondId</span><span class="p">])</span>
<span class="n">image_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">catted</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Unique image IDs: {:,}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_count</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Handshakes: {:,}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">image_count</span> <span class="o">*</span> <span class="p">(</span><span class="n">image_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
</pre></div>

<pre class="example">
Unique image IDs: 26,325
Handshakes: 346,489,650

</pre>

<p>
So the number of pairs we are given to classify is very, very small compared to the total number of possible pairs. 
</p>

<p>
To exploit the leak we need to assume (or prove), that the total number of ID-pairs classified as 1 is small compared to the total number of pairs possible. For example, think about an image dataset with \(1000\) classes, \(N\) images per class. Then if the task was to tell whether a pair of images belongs to the same class or not, we would have \(1000\frac{N(N-1)}{2}\) positive pairs, while the total number of pairs was \(\frac{1000N(1000N - 1)}{2}\).
</p>

<p>
Another example - in a <a href="https://www.kaggle.com/c/quora-question-pairs">Quora competitition</a> the task was to classify whether a pair of questions are duplicates of each other or not. Of course, the total number of question-pairs is huge, while the number of duplicates (positive pairs) is much, much smaller.
</p>
</div>

<div id="outline-container-org5bd754c" class="outline-3">
<h3 id="org5bd754c">Probing the Leaderboard</h3>
<div class="outline-text-3" id="text-org5bd754c">
<p>
Finally, let's see what fraction of the ID-pairs have a class of `1`. To do this we just need to submit a constant prediction (all ones) and check the accuracy the grader reports. Create a dataframe with columns `pairId` and `Prediction`, fill it and export it to a `.csv` file. Then submit to the Coursera grader and examine the grader's output to get the fraction of 1s in the test-set.
</p>
</div>

<div id="outline-container-orgb9976b2" class="outline-4">
<h4 id="orgb9976b2">All Ones</h4>
<div class="outline-text-4" id="text-orgb9976b2">
<div class="highlight"><pre><span></span><span class="n">paths</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">()</span>
<span class="n">all_ones</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s2">"pairId"</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">all_ones</span><span class="p">[</span><span class="s2">"Prediction"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_ones</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">all_ones</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">all_ones</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s2">"submission_ones.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>

<pre class="example">
   pairId  Prediction
0       0           1
1       1           1
2       2           1
3       3           1
4       4           1

</pre>

<p>
The submission output was:
</p>

<pre class="example">
Your accuracy score is 0.500000. It seems too low, try one more time.
</pre>

<p>
So, we assumed the that there were many more pairs overall than there were pairs of class 1, but it is not the case for the test set. This means that the test set is constructed not by sampling random pairs, but with a specific sampling algorithm which caused the pairs of class `1` to be oversampled.
</p>

<p>
Now think - how we can exploit this fact? What is the leak here? If you get it now, you may try to get to the final answer yourself, othewise you can follow the instructions below.   
</p>
</div>
</div>

<div id="outline-container-org1da1a3a" class="outline-4">
<h4 id="org1da1a3a">All Zeros</h4>
<div class="outline-text-4" id="text-org1da1a3a">
<p>
Although we're told that this was a binary data set (and you could check it just by printing out the unique values), I sort of flaked and submitted a set where all the pairs were classified as zeros anyway. Here's what happened.
</p>

<div class="highlight"><pre><span></span><span class="n">all_zeros</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s2">"pairId"</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">all_zeros</span><span class="p">[</span><span class="s2">"Prediction"</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_zeros</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">all_zeros</span><span class="o">.</span><span class="n">Prediction</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">all_zeros</span><span class="o">.</span><span class="n">pairId</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span><span class="p">(</span><span class="n">all_zeros</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">all_zeros</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s2">"submission_zeros.csv"</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>

<pre class="example">
   pairId  Prediction
0       0         0.0
1       1         0.0
2       2         0.0
3       3         0.0
4       4         0.0

</pre>


<p>
This is the grader's output.
</p>

<pre class="example">
Your accuracy score is 0.500000. It seems too low, try one more time.
</pre>

<p>
So it appears we've confirmed that the dataset is binary, with half the outputs being ones, the other half being zeros.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org3b1b5b9" class="outline-2">
<h2 id="org3b1b5b9">Building a magic feature</h2>
<div class="outline-text-2" id="text-org3b1b5b9">
<p>
In this section we will build a magic feature that will solve the problem almost perfectly. The instructions will lead you to the correct solution, but please, try to explain the purpose of the steps we do to yourself – it is very important.
</p>
</div>

<div id="outline-container-orgcd2a109" class="outline-3">
<h3 id="orgcd2a109">Incidence matrix</h3>
<div class="outline-text-3" id="text-orgcd2a109">
<p>
First, we need to build an <a href="https://en.wikipedia.org/wiki/Incidence_matrix">incidence matrix</a>. You can think of pairs `(FirstId, SecondId)` as edges in an undirected graph. 
</p>

<p>
The incidence matrix is a matrix of size `(maxId + 1, maxId + 1)`, where each row (column) `i` corresponds `i-th` `Id`. In this matrix we put the value `1` to the position `[i, j]`, if and only if a pair `(i, j)` or `(j, i)` is present in  a given set of pairs `(FirstId, SecondId)`. All the other elements in the incidence matrix are zeros.   
</p>

<p>
<b><b>Important!</b></b> The incidence matrices are typically very, very sparse (there are a small number of non-zero values). At the same time the incidence matrices are usually huge in terms of the total number of elements and it is <b><b>impossible to store them in memory in the dense format</b></b>. But due to their sparsity, incidence matrices <b><b>can be easily represented as sparse matrices</b></b>. If you are not familiar with sparse matrices, please see <a href="https://en.wikipedia.org/wiki/Sparse_matrix">wikipedia</a> and <a href="https://docs.scipy.org/doc/scipy/reference/sparse.html">scipy.sparse reference</a>. Use any of the `scipy.sparse` constructors to build incidence matrix. 
</p>

<p>
For example, you can use this constructor: `scipy.sparse.coo_matrix((data, (i, j)))`. We highly recommend you learn to use different `scipy.sparse` constuctors, and matrices types, but if you feel you don't want to use them, you can always build this matrix with a simple `for` loop. You will need to first create a matrix using `scipy.sparse.coo_matrix((M, N), [dtype])` with an appropriate shape `(M, N)` and then iterate through `(FirstId, SecondId)` pairs and fill the corresponding elements in the matrix with ones. 
</p>

<p>
<b><b>Note</b></b>, that the matrix should be symmetric and consist only of zeros and ones. This is something you can use to check your matrix.
</p>
</div>

<div id="outline-container-orgb1cd2bf" class="outline-4">
<h4 id="orgb1cd2bf">De-duplicating the Data</h4>
<div class="outline-text-4" id="text-orgb1cd2bf">
<p>
The test data turns out to have duplicate ID pairs, which will cause our incidence matrix to produce numbers greater than 1 if we leave them in, so we need to remove them (using the <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.duplicated.html">duplicated</a> method).
</p>

<div class="highlight"><pre><span></span><span class="n">pairs_1</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">FirstId</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">SecondId</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">pairs_2</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">SecondId</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">FirstId</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pairs_1</span><span class="p">,</span> <span class="n">pairs_2</span><span class="p">])</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">pairs</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pairs</span><span class="o">.</span><span class="n">duplicated</span><span class="p">())</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">pair_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">pair_count</span> <span class="o">==</span> <span class="mi">736872</span>
<span class="k">print</span><span class="p">(</span><span class="n">pair_count</span><span class="p">)</span>
</pre></div>

<pre class="example">
736872

</pre>

<p>
Which is the value provided to test the length of the matrix. Now we need to get the indices.
</p>

<div class="highlight"><pre><span></span><span class="n">i_indices</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">j_indices</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">i_indices</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">pair_count</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">j_indices</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">pair_count</span><span class="p">,)</span>
</pre></div>

<p>
Now we create a sparse matrix where the row indices are our FirstIds and the column indices are our Second Ids and each of their pairs <code>(i, j)</code> is set to 1.
</p>
<div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">pair_count</span><span class="p">)</span>
<span class="n">inc_mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">i_indices</span><span class="p">,</span> <span class="n">j_indices</span><span class="p">)))</span>

<span class="c1"># Sanity checks</span>
<span class="k">assert</span> <span class="n">inc_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">inc_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">736872</span>
</pre></div>

<p>
It is more convenient to have the incidence matrix in <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.csr_matrix.html">Compressed Sparse Row (CSR)</a> format, so convert it here.
</p>

<div class="highlight"><pre><span></span><span class="n">inc_mat</span> <span class="o">=</span> <span class="n">inc_mat</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-org2d7ea5a" class="outline-3">
<h3 id="org2d7ea5a">Now To Build the Magic Feature</h3>
<div class="outline-text-3" id="text-org2d7ea5a">
<p>
Why did we build the incidence matrix? We can think of the rows in this matrix as a representation for the objects. The `i-th` row is a representation for an object with `Id = i`. Then, to measure the similarity between two objects we can measure similarity between their representations. And we will see that these representations are very good.
</p>

<p>
Now select the rows from the incidence matrix, that correspond to `test.FirstId`'s, and `test.SecondId`'s.
</p>

<p>
Note, scipy goes crazy if a matrix is indexed with pandas' series. So do not forget to convert `pd.series` to `np.array`.
These lines should normally run very quickly.
</p>

<div class="highlight"><pre><span></span><span class="n">rows_FirstId</span>   <span class="o">=</span> <span class="n">inc_mat</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">FirstId</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">rows_SecondId</span>  <span class="o">=</span> <span class="n">inc_mat</span><span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">SecondId</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
</pre></div>

<p>
Our magic feature will be the <b>dot product</b> between representations of a pair of objects. Dot product can be regarded as similarity measure – for our non-negative representations the dot product is close to 0 when the representations are different, and is huge, when representations are similar. 
</p>

<p>
Now compute the dot product between corresponding rows in the <code>rows_FirstId</code> and <code>rows_SecondId</code> matrices.
</p>

<p>
Note, that in order to do pointwise multiplication in scipy.sparse you need to use the <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.csr_matrix.multiply.html#scipy.sparse.csr_matrix.multiply">multiply</a> function (along with a sum), the regular `*` operator corresponds to matrix-matrix multiplication. Also, the expected shape provided is only an array, not a matrix, so we can use <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.squeeze.html">numpy.squeeze</a> to get change it (from having a single column to not having a column).
</p>

<div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rows_FirstId</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rows_SecondId</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

<span class="c1"># Sanity check</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">368550</span><span class="p">,</span> <span class="p">)</span>
</pre></div>

<p>
That is it! <b><b>We've built our magic feature.</b></b> 
</p>

<div class="highlight"><pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution of Similarity Matrix (f)"</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>

<div id="outline-container-org493a4a6" class="outline-4">
<h4 id="org493a4a6">From magic feature to binary predictions</h4>
<div class="outline-text-4" id="text-org493a4a6">
<p>
But how do we convert this feature into binary predictions? We do not have a train set to learn a model, but we have a piece of information about test set: the baseline accuracy score that you got, when submitting constant. And we also have a very strong considerations about the data generative process, so probably we will be fine even without a training set. 
</p>

<p>
We may try to choose a thresold, and set the predictions to 1, if the feature value `f` is higher than the threshold, and 0 otherwise. What threshold would you choose? 
</p>

<p>
How do we find a right threshold? Let's first examine this feature: print frequencies (or counts) of each value in the feature `f`.
</p>

<div class="highlight"><pre><span></span><span class="n">f_frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">))</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">f_frame</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Value"</span> <span class="p">,</span> <span class="s2">"Count"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span>
	       <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">Value</th>
<th scope="col" class="org-right">Count</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">20</td>
<td class="org-right">183799</td>
</tr>
<tr>
<td class="org-right">14</td>
<td class="org-right">183279</td>
</tr>
<tr>
<td class="org-right">15</td>
<td class="org-right">852</td>
</tr>
<tr>
<td class="org-right">19</td>
<td class="org-right">546</td>
</tr>
<tr>
<td class="org-right">28</td>
<td class="org-right">54</td>
</tr>
<tr>
<td class="org-right">35</td>
<td class="org-right">14</td>
</tr>
<tr>
<td class="org-right">21</td>
<td class="org-right">6</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><span class="n">fractions</span> <span class="o">=</span> <span class="n">counts</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">fractions</span><span class="p">[</span><span class="s2">"Value"</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">Value</span>
<span class="k">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
	       <span class="n">floatfmt</span><span class="o">=</span><span class="s2">".3f"</span><span class="p">))</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">Value</th>
<th scope="col" class="org-right">Count</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">20.000</td>
<td class="org-right">0.499</td>
</tr>
<tr>
<td class="org-right">14.000</td>
<td class="org-right">0.497</td>
</tr>
<tr>
<td class="org-right">15.000</td>
<td class="org-right">0.002</td>
</tr>
<tr>
<td class="org-right">19.000</td>
<td class="org-right">0.001</td>
</tr>
<tr>
<td class="org-right">28.000</td>
<td class="org-right">0.000</td>
</tr>
<tr>
<td class="org-right">35.000</td>
<td class="org-right">0.000</td>
</tr>
<tr>
<td class="org-right">21.000</td>
<td class="org-right">0.000</td>
</tr>
</tbody>
</table>
<p>
So it looks like half the values are below 20 and half are above. We'll make our predictions by first getting a boolean array testing this case and then casting it to integers (0 is False, 1 is True).
</p>

<div class="highlight"><pre><span></span><span class="n">predict_twenty</span> <span class="o">=</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">20</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">submission</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">'pairId'</span><span class="p">]]</span>
<span class="n">submission</span><span class="p">[</span><span class="s1">'Prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_twenty</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s1">'predict_twenty.csv'</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>

<p>
But if you look at the table, it looks like 20 alone accounts for exactly half the values.
</p>
<div class="highlight"><pre><span></span><span class="n">predict_only_twenty</span> <span class="o">=</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">20</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">submission</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">'pairId'</span><span class="p">]]</span>
<span class="n">submission</span><span class="p">[</span><span class="s1">'Prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_only_twenty</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s1">'predict_only_twenty.csv'</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>

<p>
This is the grader output.
</p>

<pre class="example">
Well done! Your accuracy score is 0.998128 
</pre>


<div class="highlight"><pre><span></span><span class="n">predict_fourteen</span> <span class="o">=</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mi">14</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">submission</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">'pairId'</span><span class="p">]]</span>
<span class="n">submission</span><span class="p">[</span><span class="s1">'Prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_fourteen</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="s1">'predict_fourteen.csv'</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>

<p>
This was the grader output.
</p>
<pre class="example">
Well done! Your accuracy score is 0.997298
</pre>

<p>
<b><b>Finally:</b></b> try to explain to yourself, why the whole thing worked out. In fact, there is no magic in this feature, and the idea to use rows in the incidence matrix can be intuitively justified.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdf0e4e8" class="outline-2">
<h2 id="orgdf0e4e8">Bonus</h2>
<div class="outline-text-2" id="text-orgdf0e4e8">
<p>
Interestingly, it is not the only leak in this dataset. There is another totally different way to get almost 100% accuracy. Try to find it!
</p>
</div>
</div>
<div id="outline-container-org4c6f2ee" class="outline-2">
<h2 id="org4c6f2ee">What does it all mean then?</h2>
<div class="outline-text-2" id="text-org4c6f2ee">
<p>
From our initial check uploading all the submissions as one (so all the ID-pairs were classified as having IDs from the same class) we saw that half the entries were 1's and half were 0's. Our incidence matrix showed that half the vectors had a similarity of 20 or more, so by predicting that all the pairs whose incidence matrix dot-products were 20 or greater were of the same class, we could predict with greater than 99% accuracy which IDs were from the same class.
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/data-leaks/" class="u-url">Data Leaks</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/data-leaks/" rel="bookmark"><time class="published dt-published" datetime="2018-09-08T16:11:07-07:00" title="2018-09-08 16:11">2018-09-08 16:11</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-orgc295f47" class="outline-2">
<h2 id="orgc295f47">What are data leaks?</h2>
<div class="outline-text-2" id="text-orgc295f47">
<p>
<i>Data Leaks</i> are unexpected errors that expose extra information that wouldn't be available in production.
</p>
</div>
</div>
<div id="outline-container-orgc470d9c" class="outline-2">
<h2 id="orgc470d9c">Time Series</h2>
<div class="outline-text-2" id="text-orgc470d9c">
<p>
Check if there are points in the training set that are in the future with regard to the test set.
</p>
</div>
</div>
<div id="outline-container-orgf5b8f55" class="outline-2">
<h2 id="orgf5b8f55">Unexpected Information</h2>
<div class="outline-text-2" id="text-orgf5b8f55">
<p>
Sometimes what looks like a non-predictive feature might prove to be useful because of the way the data-set was created.
</p>

<ul class="org-ul">
<li>ID</li>
<li>Row Order</li>
</ul>
</div>
</div>
<div id="outline-container-org22ee9c5" class="outline-2">
<h2 id="org22ee9c5">Leaderboard Probing</h2>
<div class="outline-text-2" id="text-org22ee9c5">
<p>
This is a method to look for dataleaks based on the leader board.
</p>
</div>
</div>
<div id="outline-container-org3d1f88c" class="outline-2">
<h2 id="org3d1f88c">Quiz</h2>
<div class="outline-text-2" id="text-org3d1f88c">
</div>
<div id="outline-container-org8a8b53f" class="outline-3">
<h3 id="org8a8b53f">One</h3>
<div class="outline-text-3" id="text-org8a8b53f">
<p>
Suppose that you have a credit scoring task where you have to create a machine learning model that approximates expert evaluation of an individual's creditworthiness. Which of the following can potentially be a data leakage?
</p>

<ul class="org-ul">
<li class="on">
<code>[X]</code> An ID of a data point (row) in the train set corellates with the target variable (the data wasn't shuffled, this information won't work in a real-world scenario)</li>
<li class="on">
<code>[X]</code> The first half of the data points in the train set have a score of 0 while the second half has scores &gt; 0. (same as above)</li>
<li class="off">
<code>[ ]</code> Among he features you have a <code>company_id</code>, an identifier of a company where this person works. It turns out that this feature is important and adding it to your model improves your score. (this is a normal feature, the fact that it improves your score just means it's an important feature)</li>
</ul>
</div>
</div>
<div id="outline-container-org016f80b" class="outline-3">
<h3 id="org016f80b">Two</h3>
<div class="outline-text-3" id="text-org016f80b">
<p>
What is the most foolproof way to set up a time-series competition?
</p>
<ul class="org-ul">
<li class="on">
<code>[X]</code> Split, train, public and private parts of the data by time. Remove all features except IDs from the test set so that participants will generate all the features based on the past and join them themselves. (you need to remove all features tfrom the test set to guarantee there isn't a data-leakage)</li>

<li class="off">
<code>[ ]</code> Make a time based split for train/test and a random split for publit/private. (this is vulnerable to leaderboard probing)</li>
<li class="off">
<code>[ ]</code> split public and private by time, remove time from the test set. (it is possible to reverse engineer the time-ordering and exploit future-peeking)</li>
</ul>
</div>
</div>
<div id="outline-container-org0fb70f2" class="outline-3">
<h3 id="org0fb70f2">Three</h3>
<div class="outline-text-3" id="text-org0fb70f2">
<p>
Suppose you have a binary feature classification task and it is evaluated by the logloss metric. You know that there are 10,000 entries in the public chunk of the test set and that a constant prediction of 0.3 gets a score of 1.01. The mean of the target variable in the training set is 0.44. What is the mean of the target variable in the public part  of the test data (up to 4 decimal places.)
</p>

<ul class="org-ul">
<li>0.44 (wrong)</li>
<li>0.132 (wrong)</li>
<li>1.33 (wrong)</li>
<li>0.7712</li>
</ul>
<p>
\[
\frac{N_1}{N} = \frac{-L - \ln (1-C)}{\ln C - \ln (1 - C)}\\
= 0.7712\\
\]
</p>
</div>
</div>
<div id="outline-container-org51ae2c6" class="outline-3">
<h3 id="org51ae2c6">Four</h3>
<div class="outline-text-3" id="text-org51ae2c6">
<p>
Suppose you are solving an image classification task, what is the classification of the logo for this course?
</p>
<ul class="org-ul">
<li>Angry robot (wrong - should be a number)</li>
<li>1 (wrong - check image name)</li>
<li>3 (the URL for the image had the answer in it)</li>
</ul>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/validation/" class="u-url">Validation</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/validation/" rel="bookmark"><time class="published dt-published" datetime="2018-09-04T08:01:59-07:00" title="2018-09-04 08:01">2018-09-04 08:01</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/validation/#org22f02cf">Validation and Overfitting</a></li>
<li><a href="posts/validation/#org053f296">Three Main Methods of Splitting</a></li>
<li><a href="posts/validation/#org93d900d">Stratification</a></li>
<li><a href="posts/validation/#org069e155">Data Splitting</a></li>
<li><a href="posts/validation/#orgc0e900d">Problems</a></li>
<li><a href="posts/validation/#org4c3fbf9">Practice Quiz</a></li>
<li><a href="posts/validation/#orgd762960">Quiz</a></li>
<li><a href="posts/validation/#org81acef0">Links</a></li>
</ul>
</div>
</div>

<div id="outline-container-org22f02cf" class="outline-2">
<h2 id="org22f02cf">Validation and Overfitting</h2>
<div class="outline-text-2" id="text-org22f02cf">
<p>
To prevent your model from overfitting to the training set, you can hold out some of the training set and use it to validate the model after it has been fit to the rest of the training set.
</p>
<ul class="org-ul">
<li>Underfitting: your model isn't complex enough to capture the data</li>
<li>Overfitting: your model is too complex and it is modelling noise in the data</li>
<li>In a competition, if your model does well on the validation set but not on the test set, then it probably overfit the data you had</li>
</ul>
</div>
</div>
<div id="outline-container-org053f296" class="outline-2">
<h2 id="org053f296">Three Main Methods of Splitting</h2>
<div class="outline-text-2" id="text-org053f296">
<p>
These are methods for splitting your training set into training and validation sets. Once you have a model, re-train it over the entire training set before applying it to the test set.
</p>
</div>
<div id="outline-container-orge858c0c" class="outline-3">
<h3 id="orge858c0c">Holdout</h3>
<div class="outline-text-3" id="text-orge858c0c">
<p>
This method just splits the data into one training and one validation set.
</p>

<ul class="org-ul">
<li><a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.ShuffleSplit.html">sklearn.model_selection.ShuffleSplit</a></li>
<li><code>ngroups=1</code></li>
</ul>
</div>
</div>
<div id="outline-container-orgd2d4371" class="outline-3">
<h3 id="orgd2d4371">K-Fold</h3>
<div class="outline-text-3" id="text-orgd2d4371">
<p>
Make <i>k</i> splits of the training set, then use each of the validation sets while training on all the data not in the validation set. This differs from doing holdout k-times since we guarantee that the validation sets don't overlap. Uses the average score for the k-folds.
</p>

<ul class="org-ul">
<li><a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html">sklearn.model_selection.KFold</a></li>
</ul>
</div>
</div>
<div id="outline-container-org36c6407" class="outline-3">
<h3 id="org36c6407">Leave One Out</h3>
<div class="outline-text-3" id="text-org36c6407">
<p>
This is like k-folds except we always use a validation set of size 1 - so we are iterating over each point in the data set and using it as the training set. This can be useful if the data set is small.
</p>
<ul class="org-ul">
<li><a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.LeaveOneOut.html">sklearn.model_selection.LeaveOneOut</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org93d900d" class="outline-2">
<h2 id="org93d900d">Stratification</h2>
<div class="outline-text-2" id="text-org93d900d">
<p>
Sometimes you need to make sure your validation sets have the same distribution as your set as a whole.
</p>
<ul class="org-ul">
<li>small datasets</li>
<li>unbalanced datasects</li>
<li>multiclass classification</li>
<li><a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedShuffleSplit.html">StratifieShuffleSplit</a></li>
</ul>
</div>
</div>
<div id="outline-container-org069e155" class="outline-2">
<h2 id="org069e155">Data Splitting</h2>
<div class="outline-text-2" id="text-org069e155">
<p>
If you have time-based data, there's two ways to split the training data - randomly within the entire timespan, or put the first part of the data in the training set and put the second part of the data in the validation set. If the test-set is a time that is beyond the training data, then using the time-based split will produce a model that is better for the testing data.
</p>
<ol class="org-ol">
<li>Row-wise split
This is the most common case, where rows are randomly chosen from the training data. This assumes the rows are independent.</li>
<li>Time-wise split
This is the case where you are predicting future values of a time-series. In this case, the further back in time a row is, the less like the future value it is.</li>
<li>By-ID
In this case several rows map to one ID, and the ID maps to a target. For example, you might have several x-rays for one patient that map to one diagnosis.</li>
</ol>
<p>
The main point of this is that you want to set up your validation set to match the way the train-test sets were split.
</p>
</div>
</div>
<div id="outline-container-orgc0e900d" class="outline-2">
<h2 id="orgc0e900d">Problems</h2>
<div class="outline-text-2" id="text-orgc0e900d">
<p>
The point of doing the training-validation split is that you think the validation set(s) will approximate the test set. But what if that's not true?
</p>
</div>
<div id="outline-container-orgedb54c7" class="outline-3">
<h3 id="orgedb54c7">Causes of score differences</h3>
<div class="outline-text-3" id="text-orgedb54c7">
<ul class="org-ul">
<li>Too little data</li>
<li>The data is too diverse and inconsistent</li>
</ul>
</div>
</div>
<div id="outline-container-org6dcbb3d" class="outline-3">
<h3 id="org6dcbb3d">Submission Differs from Validation</h3>
<div class="outline-text-3" id="text-org6dcbb3d">
<ol class="org-ol">
<li>Even K-fold validation has variation (check that the standard deviation across folds encompasses the leaderboard values)</li>
<li>Too little data on leaderboard (nothing you can do)</li>
<li>Train and test are from different distributions</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org4c3fbf9" class="outline-2">
<h2 id="org4c3fbf9">Practice Quiz</h2>
<div class="outline-text-2" id="text-org4c3fbf9">
</div>
<div id="outline-container-org96b8ead" class="outline-3">
<h3 id="org96b8ead">One</h3>
<div class="outline-text-3" id="text-org96b8ead">
<p>
We did a K-Fold cross validation on a huge dataset and noticed that scores on each fold are roughly the same. Which validation type is of most practical use?
</p>
<ul class="org-ul">
<li class="off">
<code>[ ]</code> K-Fold</li>
<li class="on">
<code>[X]</code> Holdout</li>
<li class="off">
<code>[ ]</code> Leave one out</li>
</ul>
</div>
</div>
<div id="outline-container-org3b5030d" class="outline-3">
<h3 id="org3b5030d">Two</h3>
<div class="outline-text-3" id="text-org3b5030d">
<p>
We did a K-fold cross validation on a medium sized dataset and noticed that the validation scores varied widely. Which validation type is the most practical to use?
</p>
<ul class="org-ul">
<li class="off">
<code>[ ]</code> Leave One Out</li>
<li class="on">
<code>[X]</code> K Fold</li>
<li class="off">
<code>[ ]</code> Houldout</li>
</ul>
</div>
</div>
<div id="outline-container-orga16d003" class="outline-3">
<h3 id="orga16d003">Three</h3>
<div class="outline-text-3" id="text-orga16d003">
<p>
The features we generate depend on the train-test split. True or False?
</p>
<ul class="org-ul">
<li class="on">
<code>[X]</code> True</li>
<li class="off">
<code>[ ]</code> False</li>
</ul>
</div>
</div>
<div id="outline-container-orgbf8dc24" class="outline-3">
<h3 id="orgbf8dc24">Which of these can indicate an expected leaderboard shuffle in a competition?</h3>
<div class="outline-text-3" id="text-orgbf8dc24">
<ul class="org-ul">
<li class="on">
<code>[X]</code> Little training and/or testing data</li>
<li class="on">
<code>[X]</code> Most of the competitors have similar scores</li>
<li class="on">
<code>[X]</code> Different public/private data or target distributions</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd762960" class="outline-2">
<h2 id="orgd762960">Quiz</h2>
<div class="outline-text-2" id="text-orgd762960">
</div>
<div id="outline-container-org0f99d6e" class="outline-3">
<h3 id="org0f99d6e">One</h3>
<div class="outline-text-3" id="text-org0f99d6e">
<p>
Select the true statements.
</p>
<ul class="org-ul">
<li class="off">
<code>[ ]</code> A performance increase on a fixed cross-validation split guarantees a performance increase on any cross-validation split. (You might be overfitting. You should change the splits to check for overfitting.)</li>
<li class="on">
<code>[X]</code> The logic behind the validation split should mimic the logic behind the train-test split (this is the main rule for making a reliable validation)</li>
<li class="on">
<code>[X]</code> Underfitting refers to not capturing enough patterns in the data</li>
<li class="on">
<code>[X]</code> We use validation to estimate the quality of our model (this is the main purpose of validation)</li>
<li class="off">
<code>[ ]</code> The model that does on the validation set is guaranteed to do the best on the test set. (The test and validation sets might have different distributions, in which case the validation won't predict the test set score)</li>
</ul>
</div>
</div>
<div id="outline-container-orgd32fb63" class="outline-3">
<h3 id="orgd32fb63">Two</h3>
<div class="outline-text-3" id="text-orgd32fb63">
<p>
Kaggle usually allows you to submit two final submissions that will be checked against the private leader board. One common practice is to use a model that did the best on the validation scores and another that did best on the public leader board. What is the logic behind using these two models?
</p>
<ul class="org-ul">
<li class="off">
<code>[ ]</code> People rarely overfit the public leaderboard. You almost always have a lot of test data and it is hard to overfit.</li>
<li class="off">
<code>[ ]</code> Validation is rarely valid in competitions. You must account for the case where validation worked and where it didn't.</li>
<li class="on">
<code>[X]</code> The test set may have a different distribution than the target data. If this is true, then the model that did better on the public leaderboard will do better. If not, then the model that did better in validation will do better.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfe98d1d" class="outline-3">
<h3 id="orgfe98d1d">Three</h3>
<div class="outline-text-3" id="text-orgfe98d1d">
<p>
Suppose we have a dataset of marketing campaigns. Each campain runs for a few weeks and for each campaign our target is the number of new customers. A row in the dataset looks like this:
</p>

<p>
<i>Campaign ID, Date, {some features},Number of New Customers</i>
</p>

<p>
The dataset contains multiple campaigns where the training set has the dates at the start of each campaign and the test set has the dates at the end of each campaign. Which train/test split should you use?
</p>

<ul class="org-ul">
<li class="off">
<code>[ ]</code> Random Split</li>
<li class="on">
<code>[X]</code> Combined Split (Each train and test set are divided by a date and the date might be for different campaigns, so it is a combination of campaign ID and date)</li>
<li class="off">
<code>[ ]</code> ID-based split (wrong)</li>
<li class="off">
<code>[ ]</code> Time-based split (wrong)</li>
</ul>
</div>
</div>
<div id="outline-container-orgc3bf35f" class="outline-3">
<h3 id="orgc3bf35f">Four</h3>
<div class="outline-text-3" id="text-orgc3bf35f">
<p>
Which of the following can you usually identify without the leaderboard?
</p>
<ul class="org-ul">
<li class="on">
<code>[X]</code> Different scores/optimal parameters between different folds (this is determined during validation)</li>
<li class="off">
<code>[ ]</code> Train and test target data are from different distributions (You would need the test target values to figure this out, which you won't have)</li>
<li class="on">
<code>[X]</code> The public leaderboard score will be unreliable because there is too little data (you can check this by making the size of the folds match the size of the public test set and see the variability)</li>
<li class="on">
<code>[X]</code> The train and test data are from different distributions (you can often figure this out during Exploratory Data Analysis)</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org81acef0" class="outline-2">
<h2 id="org81acef0">Links</h2>
<div class="outline-text-2" id="text-org81acef0">
<ul class="org-ul">
<li><a href="http://scikit-learn.org/stable/modules/cross_validation.html">Cross-validation in sklearn</a></li>
<li><a href="http://www.chioka.in/how-to-select-your-final-models-in-a-kaggle-competitio/">Model Selection for Kaggle</a></li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/springleaf-competition/" class="u-url">Springleaf Competition</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/springleaf-competition/" rel="bookmark"><time class="published dt-published" datetime="2018-09-04T06:35:25-07:00" title="2018-09-04 06:35">2018-09-04 06:35</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-orgfea27b7" class="outline-2">
<h2 id="orgfea27b7">Introduction</h2>
<div class="outline-text-2" id="text-orgfea27b7">
<p>
The data comes from the <a href="https://www.kaggle.com/c/springleaf-marketing-response">Springleaf Marketing Response</a> competition. Springleaf makes personal loans and wanted to be able to predict who would respond to their direct mail offers. Submissions are evaluated on the area under the ROC curve between the predicted probability and the target. The submission file should have an ID and the probability that the person would respond.
</p>

<pre class="example">
ID,target
1,0.35
3,0.01
6,0.93333
</pre>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/exploratory-data-analysis/" class="u-url">Exploratory Data Analysis</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/exploratory-data-analysis/" rel="bookmark"><time class="published dt-published" datetime="2018-09-03T21:24:53-07:00" title="2018-09-03 21:24">2018-09-03 21:24</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/exploratory-data-analysis/#org34aeac3">Building Your Intuition About the Data</a></li>
<li><a href="posts/exploratory-data-analysis/#org58a45f9">Exploring Anonymized Data</a></li>
<li><a href="posts/exploratory-data-analysis/#org964784e">Visualizations</a></li>
<li><a href="posts/exploratory-data-analysis/#orgd36fdd7">Data Set Cleaning</a></li>
<li><a href="posts/exploratory-data-analysis/#org7a22654">Quiz</a></li>
<li><a href="posts/exploratory-data-analysis/#orgab031c9">Links</a></li>
</ul>
</div>
</div>

<div id="outline-container-org34aeac3" class="outline-2">
<h2 id="org34aeac3">Building Your Intuition About the Data</h2>
<div class="outline-text-2" id="text-org34aeac3">
<p>
The first thing to do is to see if you can build up a mental model of what the data is about.
</p>
</div>
<div id="outline-container-orge290e37" class="outline-3">
<h3 id="orge290e37">Get Domain Knowledge</h3>
<div class="outline-text-3" id="text-orge290e37">
<p>
Find out something about the topic that the data describes.
</p>
</div>
</div>
<div id="outline-container-org1ec5444" class="outline-3">
<h3 id="org1ec5444">Check if the Data is intuitive</h3>
<div class="outline-text-3" id="text-org1ec5444">
<p>
See if there are any strange values and see if it makes sense given the data description.
</p>
</div>
</div>
<div id="outline-container-orgfd5e207" class="outline-3">
<h3 id="orgfd5e207">Understand how the data was generated</h3>
<div class="outline-text-3" id="text-orgfd5e207">
<p>
Is any of it synthetic? Was the training data generated the same way as the testing data?
</p>
</div>
</div>
</div>
<div id="outline-container-org58a45f9" class="outline-2">
<h2 id="org58a45f9">Exploring Anonymized Data</h2>
<div class="outline-text-2" id="text-org58a45f9">
<p>
Organizers sometimes encode data so you can't tell what it is.
</p>
</div>
<div id="outline-container-org63adc49" class="outline-3">
<h3 id="org63adc49">Try To Decode the Data</h3>
<div class="outline-text-3" id="text-org63adc49">
<p>
You generally won't be able to figure out what the data is if it's encoded, but sometimes they were created using simple shifting schemes that will let you figure out their original values.
</p>
</div>
</div>
<div id="outline-container-orgb285210" class="outline-3">
<h3 id="orgb285210">Explore Individual Features</h3>
<div class="outline-text-3" id="text-orgb285210">
<p>
Even if you don't know what the data is, it's important to know what type of data it is so that you can use the right data preprocessing for your model.
</p>
<ul class="org-ul">
<li><a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.dtypes.html">df.dtypes</a></li>
<li><a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.info.html">df.info()</a></li>
<li><a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.Series.value_counts.html">x.value_counts()</a></li>
<li><a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.isnull.html">x.isnull()</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org964784e" class="outline-2">
<h2 id="org964784e">Visualizations</h2>
<div class="outline-text-2" id="text-org964784e">
</div>
<div id="outline-container-org8abebf3" class="outline-3">
<h3 id="org8abebf3">Features</h3>
<div class="outline-text-3" id="text-org8abebf3">
</div>
<div id="outline-container-org73e5197" class="outline-4">
<h4 id="org73e5197">Histograms</h4>
<div class="outline-text-4" id="text-org73e5197">
<p>
This is useful for seeing the shape of the data.
</p>
<ul class="org-ul">
<li><code>pyplot.hist(x)</code></li>
</ul>
</div>
</div>
<div id="outline-container-orgfcd7453" class="outline-4">
<h4 id="orgfcd7453">Index vs Value</h4>
<div class="outline-text-4" id="text-orgfcd7453">
<p>
This will show you how well distributed the data is within the data frame. Horizontal lines indicate repeated values and empty bands show areas where none of the data had this value. If you don't have vertical lines then the data was probably shuffled.
</p>
<ul class="org-ul">
<li><code>pyplot.plot(x, '.')</code></li>
</ul>
</div>
</div>
<div id="outline-container-org594802b" class="outline-4">
<h4 id="org594802b">Index vs Value Colored By Class Label</h4>
<div class="outline-text-4" id="text-org594802b">
<p>
If you plot the classes with different colors you can see if there are clusters and clear separations between them. (<code>y</code> in the function call has the target values).
</p>
<ul class="org-ul">
<li><code>pyplot.scatter(range(len(x)), x, c=y)</code></li>
</ul>
</div>
</div>
<div id="outline-container-org148847a" class="outline-4">
<h4 id="org148847a">Plot Other Things</h4>
<div class="outline-text-4" id="text-org148847a">
<ul class="org-ul">
<li>Row vs Feature</li>
<li>Nan-values</li>
<li>Value Counts</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgfe49d8e" class="outline-3">
<h3 id="orgfe49d8e">Relationships</h3>
<div class="outline-text-3" id="text-orgfe49d8e">
</div>
<div id="outline-container-orgbdae5b1" class="outline-4">
<h4 id="orgbdae5b1">Scatter Plots</h4>
<div class="outline-text-4" id="text-orgbdae5b1">
</div>
<ul class="org-ul">
<li>
<a id="orge6bcb3a"></a>Pairwise Relationships<br><div class="outline-text-5" id="text-orge6bcb3a">
<p>
To make it eaiser to see relationships, you can plot them in pairs.
</p>
<ul class="org-ul">
<li><code>pyplot.scatter(x1, x2)</code></li>
</ul>
</div>
</li>
<li>
<a id="orgb75b450"></a>Compare the Test Set<br><div class="outline-text-5" id="text-orgb75b450">
<p>
Plot the features and the test-set (using different colors) to see how well your training data matches your test data.
</p>
</div>
</li>
<li>
<a id="org55ad28c"></a>Scatter Matrix<br><div class="outline-text-5" id="text-org55ad28c">
<p>
Pandas has a convenience function that will plot all the pairwise scatter-plots for you.
</p>
<ul class="org-ul">
<li><code>pandas.scatter_matrix(X)</code></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org2764dde" class="outline-4">
<h4 id="org2764dde">Corellation</h4>
<div class="outline-text-4" id="text-org2764dde">
<p>
Plot the corellation matrix to see if there are feature-pairs that are related so you can make a new feature out of them and see if they help.
</p>
<ul class="org-ul">
<li><code>X.corr(), pyplot.matshow()</code></li>
</ul>
<p>
A straight correllation matrix might give you a sense of how correllated the features are, but it's more useful to use a clustering algorithm to see if there are groups within the correlation matrix.
</p>
</div>
</div>
<div id="outline-container-org154ea12" class="outline-4">
<h4 id="org154ea12">Plot Statistics</h4>
<div class="outline-text-4" id="text-org154ea12">
<p>
Try plotting mean, differences, combination counts, etc. and see if you can create groups out of them.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd36fdd7" class="outline-2">
<h2 id="orgd36fdd7">Data Set Cleaning</h2>
<div class="outline-text-2" id="text-orgd36fdd7">
</div>
<div id="outline-container-org94aa88c" class="outline-3">
<h3 id="org94aa88c">Duplicated and Constant Features</h3>
<div class="outline-text-3" id="text-org94aa88c">
<p>
Sometimes a feature will have the same value in all the rows. If it's this way in both the training and test sets you can just remove it, but if there are different values in the test set you have to figure out how to handle them.
</p>
<ul class="org-ul">
<li>
<code>x_train.nunique(axis</code>"columns") <code>= 1</code>
</li>
</ul>
<p>
Sometimes columns will get duplicated in which case you should drop one of them.
</p>

<ul class="org-ul">
<li><code>x_train.T.drop_duplicates()</code></li>
</ul>
<p>
This can happen with rows as well, but it can be harder to decide whether this is a mistake or not.
</p>
</div>
</div>
<div id="outline-container-org5638e7a" class="outline-3">
<h3 id="org5638e7a">Non-shuffled Data</h3>
<div class="outline-text-3" id="text-org5638e7a">
<p>
If you plot the mean as a horizontal line the data should be evenly distributed around it, if not it might not have been shuffled and there could be an inadvertent pattern in the data. You might not be able to use it, but you should understand all the things about the data that you can find out.
</p>
</div>
</div>
</div>
<div id="outline-container-org7a22654" class="outline-2">
<h2 id="org7a22654">Quiz</h2>
<div class="outline-text-2" id="text-org7a22654">
</div>
<div id="outline-container-orgf4f7ea1" class="outline-3">
<h3 id="orgf4f7ea1">One</h3>
<div class="outline-text-3" id="text-orgf4f7ea1">
<p>
Suppose we are given a data set with features <i>X</i>, <i>Y</i>, and <i>Z</i>. Can you recover <i>z</i> as a function of <i>x</i> and <i>y</i>?
</p>
<ul class="org-ul">
<li class="on">
<code>[X]</code> Z = X/Y</li>
<li class="off">
<code>[ ]</code> Z = X - Y</li>
<li class="off">
<code>[ ]</code> Z = X + Y</li>
<li class="off">
<code>[ ]</code> Z = XY</li>
</ul>
</div>
</div>
<div id="outline-container-org341a38f" class="outline-3">
<h3 id="org341a38f">Two</h3>
<div class="outline-text-3" id="text-org341a38f">
<p>
What value do the red dots have?
0.5 (wrong)
2 (next try)
</p>
</div>
</div>
<div id="outline-container-org8f74676" class="outline-3">
<h3 id="org8f74676">Three</h3>
<div class="outline-text-3" id="text-org8f74676">
<p>
What hypothesis about X can we not reject based on the plots?
</p>
<ul class="org-ul">
<li class="on">
<code>[X]</code> X is a counter or label encoded categorical feature</li>
<li class="off">
<code>[ ]</code> X can be the temperature (in Celsius) in different cities at different times. (the values are probably out of range)</li>
<li class="off">
<code>[ ]</code> X can take a value of zero (The log plot would have values at 0 but it doesn't)</li>
<li class="on">
<code>[X]</code> X takes only discrete values (the horizontal lines indicate that there are repeated values with discrete values)</li>
<li class="on">
<code>[X]</code> 2 &lt;= X &lt; 3 happens more frequently than 3 &lt;= X &lt; 4</li>
</ul>
</div>
</div>
<div id="outline-container-org709ea18" class="outline-3">
<h3 id="org709ea18">Four</h3>
<div class="outline-text-3" id="text-org709ea18">
<ul class="org-ul">
<li class="off">
<code>[ ]</code> Target is completely determined by coordinates (x,y)(x,y)(x,y), i.e. the label of the point is completely determined by point's position (x,y)(x,y)(x,y). Saying the same in other words: if we only had two features (x,y)(x,y)(x,y), we could build a classifier, that is accurate 100% of time.</li>
<li class="on">
<code>[X]</code> The top right plot is better than the top left in that everything you get from the top left can also be gotten from the top right, but not the other way around.</li>
<li class="on">
<code>[X]</code> standard deviation for jittering is the largest on the bottom right.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgab031c9" class="outline-2">
<h2 id="orgab031c9">Links</h2>
<div class="outline-text-2" id="text-orgab031c9">
<ul class="org-ul">
<li><a href="http://scikit-learn.org/stable/auto_examples/bicluster/plot_spectral_biclustering.html">Sorting Correlation Plots</a></li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/references/" class="u-url">References</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/references/" rel="bookmark"><time class="published dt-published" datetime="2018-09-01T12:16:46-07:00" title="2018-09-01 12:16">2018-09-01 12:16</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-org7d1c686" class="outline-2">
<h2 id="org7d1c686">Bibliography</h2>
<div class="outline-text-2" id="text-org7d1c686">
<ul class="org-ul">
<li>[B1] 1. Albon C. Machine learning with Python cookbook: practical solutions from preprocessing to deep learning. First edition. Beijing Boston Farnham: O’Reilly; 2018. 349 p.</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/the-target/" class="u-url">The Target</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/the-target/" rel="bookmark"><time class="published dt-published" datetime="2018-08-31T13:29:42-07:00" title="2018-08-31 13:29">2018-08-31 13:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/the-target/#orgd1ebbe7">Introduction</a></li>
<li><a href="posts/the-target/#orgec884df">Imports</a></li>
<li><a href="posts/the-target/#org26f5701">The Data</a></li>
<li><a href="posts/the-target/#org2071a31">Dates</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd1ebbe7" class="outline-2">
<h2 id="orgd1ebbe7">Introduction</h2>
<div class="outline-text-2" id="text-orgd1ebbe7">
<p>
This is some stuff about what we are trying to predict. I realized that the description of the competition says that we are trying to predict the number of items sold per shop for the next month after the data, but I never said what that month is, so I'm making this just to put it somewhere.
</p>
</div>
</div>
<div id="outline-container-orgec884df" class="outline-2">
<h2 id="orgec884df">Imports</h2>
<div class="outline-text-2" id="text-orgec884df">
<div class="highlight"><pre><span></span>import warnings
warnings.filterwarnings("ignore", message="numpy.dtype size changed")
warnings.filterwarnings("ignore", message="numpy.ufunc size changed")
</pre></div>
</div>

<div id="outline-container-org90b1fa6" class="outline-3">
<h3 id="org90b1fa6">From pypi</h3>
<div class="outline-text-3" id="text-org90b1fa6">
<div class="highlight"><pre><span></span>import pandas
import matplotlib.pyplot as pyplot
import seaborn
</pre></div>
</div>
</div>

<div id="outline-container-orgbed6595" class="outline-3">
<h3 id="orgbed6595">This project</h3>
<div class="outline-text-3" id="text-orgbed6595">
<div class="highlight"><pre><span></span>from kaggler.helpers.build_training_data import Pickles
from kaggler.helpers.helpers import (
    DataKeys,
    Helpers,
    )
</pre></div>
</div>
</div>

<div id="outline-container-org5c3dfe7" class="outline-3">
<h3 id="org5c3dfe7">Setting up the plotting</h3>
<div class="outline-text-3" id="text-org5c3dfe7">
<div class="highlight"><pre><span></span>% matplotlib inline
seaborn.set_style("whitegrid")
</pre></div>
</div>
</div>
</div>

<div id="outline-container-org26f5701" class="outline-2">
<h2 id="org26f5701">The Data</h2>
<div class="outline-text-2" id="text-org26f5701">
<div class="highlight"><pre><span></span>x_train = Helpers.unpickle(Pickles.x_train)
y_train = Helpers.unpickle(Pickles.y_train)
x_test = Helpers.unpickle(Pickles.x_test)
</pre></div>

<p>
Although it seem unlikely, it's possible that there are months in either the test or training set that aren't shared, so I'm going to concatenate them.
</p>

<div class="highlight"><pre><span></span>concatenated = pandas.concat([x_train, x_test], axis="rows")
assert concatenated.shape == (len(x_train) + len(x_test), len(x_train.columns))
</pre></div>
</div>
</div>

<div id="outline-container-org2071a31" class="outline-2">
<h2 id="org2071a31">Dates</h2>
<div class="outline-text-2" id="text-org2071a31">
<p>
Unfortunately I got rid of the days, which are required by the <a href="https://pandas.pydata.org/pandas-docs/stable/timeseries.html">to_datetime</a> function provided by pandas, so I'm going to construct a new date column with a day of 1 for each date.
</p>

<div class="highlight"><pre><span></span>DataKeys.date = "Date"
DataKeys.datetime = "Date Time"
concatenated[DataKeys.date] = "01-" + concatenated.month + '-' + concatenated.year
concatenated[DataKeys.datetime] = pandas.to_datetime(
    concatenated[DataKeys.date], format="%d-%m-%Y")
Helpers.print_head(concatenated)
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-left">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
<th scope="col" class="org-right">Date</th>
<th scope="col" class="org-left">Date Time</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">11</td>
<td class="org-right">15</td>
<td class="org-right">1324</td>
<td class="org-right">499</td>
<td class="org-right">55</td>
<td class="org-right">12</td>
<td class="org-right">2013</td>
<td class="org-right">01-12-2013</td>
<td class="org-left">2013-12-01 00:00:00</td>
</tr>
<tr>
<td class="org-right">18</td>
<td class="org-right">31</td>
<td class="org-right">19981</td>
<td class="org-right">499</td>
<td class="org-right">43</td>
<td class="org-right">07</td>
<td class="org-right">2014</td>
<td class="org-right">01-07-2014</td>
<td class="org-left">2014-07-01 00:00:00</td>
</tr>
<tr>
<td class="org-right">32</td>
<td class="org-right">28</td>
<td class="org-right">7934</td>
<td class="org-right">398</td>
<td class="org-right">7</td>
<td class="org-right">09</td>
<td class="org-right">2015</td>
<td class="org-right">01-09-2015</td>
<td class="org-left">2015-09-01 00:00:00</td>
</tr>
<tr>
<td class="org-right">12</td>
<td class="org-right">43</td>
<td class="org-right">13518</td>
<td class="org-right">1499</td>
<td class="org-right">19</td>
<td class="org-right">01</td>
<td class="org-right">2014</td>
<td class="org-right">01-01-2014</td>
<td class="org-left">2014-01-01 00:00:00</td>
</tr>
<tr>
<td class="org-right">28</td>
<td class="org-right">25</td>
<td class="org-right">19927</td>
<td class="org-right">329</td>
<td class="org-right">57</td>
<td class="org-right">05</td>
<td class="org-right">2015</td>
<td class="org-right">01-05-2015</td>
<td class="org-left">2015-05-01 00:00:00</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span>print(concatenated[DataKeys.datetime].max())
</pre></div>

<p>
So the last month in the data-set is October 2015, and we want to predict what the counts will be for November 2015.
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/some-plots-of-the-data/" class="u-url">Some Plots of the Data</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/some-plots-of-the-data/" rel="bookmark"><time class="published dt-published" datetime="2018-08-29T14:19:26-07:00" title="2018-08-29 14:19">2018-08-29 14:19</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/some-plots-of-the-data/#orgdf3191d">Imports</a></li>
<li><a href="posts/some-plots-of-the-data/#orgaa9eaa0">Build the data</a></li>
<li><a href="posts/some-plots-of-the-data/#orge990728">More Helpers</a></li>
<li><a href="posts/some-plots-of-the-data/#orgca22900">Features vs Target</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgdf3191d" class="outline-2">
<h2 id="orgdf3191d">Imports</h2>
<div class="outline-text-2" id="text-orgdf3191d">
<div class="highlight"><pre><span></span>import warnings
warnings.filterwarnings("ignore", message="numpy.dtype size changed")
warnings.filterwarnings("ignore", message="numpy.ufunc size changed")
</pre></div>
</div>

<div id="outline-container-orgb579982" class="outline-3">
<h3 id="orgb579982">From pypi</h3>
<div class="outline-text-3" id="text-orgb579982">
<div class="highlight"><pre><span></span>import matplotlib.pyplot as pyplot
import numpy
import seaborn
</pre></div>

<div class="highlight"><pre><span></span>%matplotlib inline
seaborn.set_style("whitegrid")
</pre></div>
</div>
</div>

<div id="outline-container-org398095b" class="outline-3">
<h3 id="org398095b">This project</h3>
<div class="outline-text-3" id="text-org398095b">
<div class="highlight"><pre><span></span>from kaggler.helpers.build_training_data import Pickles
from kaggler.helpers.helpers import (
    DataKeys,
    Helpers,
    )
</pre></div>
</div>
</div>
</div>

<div id="outline-container-orgaa9eaa0" class="outline-2">
<h2 id="orgaa9eaa0">Build the data</h2>
<div class="outline-text-2" id="text-orgaa9eaa0">
<div class="highlight"><pre><span></span>x_train = Helpers.unpickle(Pickles.x_train)
y_train = Helpers.unpickle(Pickles.y_train)
DataKeys.target = "Month Count"
x_train[DataKeys.target] = y_train.values
Helpers.print_head(x_train)
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
<th scope="col" class="org-right">Month Count</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">11</td>
<td class="org-right">15</td>
<td class="org-right">1324</td>
<td class="org-right">499</td>
<td class="org-right">55</td>
<td class="org-right">12</td>
<td class="org-right">2013</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">18</td>
<td class="org-right">31</td>
<td class="org-right">19981</td>
<td class="org-right">499</td>
<td class="org-right">43</td>
<td class="org-right">07</td>
<td class="org-right">2014</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-right">32</td>
<td class="org-right">28</td>
<td class="org-right">7934</td>
<td class="org-right">398</td>
<td class="org-right">7</td>
<td class="org-right">09</td>
<td class="org-right">2015</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">12</td>
<td class="org-right">43</td>
<td class="org-right">13518</td>
<td class="org-right">1499</td>
<td class="org-right">19</td>
<td class="org-right">01</td>
<td class="org-right">2014</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">28</td>
<td class="org-right">25</td>
<td class="org-right">19927</td>
<td class="org-right">329</td>
<td class="org-right">57</td>
<td class="org-right">05</td>
<td class="org-right">2015</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orge990728" class="outline-2">
<h2 id="orge990728">More Helpers</h2>
<div class="outline-text-2" id="text-orge990728">
<div class="highlight"><pre><span></span>def make_figure_and_axis(x_label, y_label, title, figsize=(10, 8)):
    """make a matplotlib figure

    Args:
     x_label (str): label for the x-axis
     y_label (str): label for the y-axis
     title (str): title for the plot
     figsize: tuple of width, height
    Returns:
     tuple: figure, axis
    """
    figure = pyplot.figure(figsize=figsize)
    axe = figure.gca()
    axe.set_xlabel(x_label)
    axe.set_ylabel(y_label)
    axe.set_title(title)
    return figure, axe
</pre></div>
</div>
</div>
<div id="outline-container-orgca22900" class="outline-2">
<h2 id="orgca22900">Features vs Target</h2>
<div class="outline-text-2" id="text-orgca22900">
</div>
<div id="outline-container-org00c5298" class="outline-3">
<h3 id="org00c5298">Date Block</h3>
<div class="outline-text-3" id="text-org00c5298">
<div class="highlight"><pre><span></span>figure, axis = make_figure_and_axis("Date Block", "Count", "Date-Block Counts")
grid = seaborn.catplot(ax=axis, x=DataKeys.date_block, kind="count", data=x_train)
</pre></div>

<p>
The counts represent the number of shop-product pairs per-month, which isn't really what we want. We want the count per-product per month. As an intermediary step, why don't we look at the total count as it changes over time.
</p>

<div class="highlight"><pre><span></span>date_group = x_train.groupby(DataKeys.date_block)
summed = date_group.sum()
summed = summed.reset_index()
figure, axis = make_figure_and_axis("Date Block", "Monthly Count",
				    "Total Items Sold Per Month")
grid = seaborn.relplot(x=DataKeys.date_block, y=DataKeys.target, ax=axis,
		       data=summed, kind="line")
</pre></div>

<p>
This seems to indicate that sales are going down overall over time. Those spikes are interesting, maybe the months would be interesting. First we need to re-join the month and year together so the sorting of the x-axis will work okay.
</p>

<div class="highlight"><pre><span></span>DataKeys.date = "Date"
x_train[DataKeys.date] = x_train.year + "-" + x_train.month
month_grouped = x_train.groupby(DataKeys.date)
month_summed = month_grouped.sum().reset_index()
</pre></div>

<div class="highlight"><pre><span></span>top_two = month_summed.sort_values(DataKeys.target, ascending=False)[:2]
figure, axis = make_figure_and_axis("Month", "Count", "Items Sold Per Month",
				    figsize=(12,10))

pyplot.xticks(rotation=45, ha="right")
grid = seaborn.relplot(x=DataKeys.date, y=DataKeys.target, data=month_summed,
		       ax=axis, kind="line")
axis.axvline(top_two.index[0], color='r')
line = axis.axvline(top_two.index[1], color='r')
</pre></div>

<div class="highlight"><pre><span></span>Helpers.print_table(top_two[[DataKeys.date, DataKeys.target]])
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right"> </th>
<th scope="col" class="org-right">Date</th>
<th scope="col" class="org-right">Month Count</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">11</td>
<td class="org-right">2013-12</td>
<td class="org-right">147909</td>
</tr>
<tr>
<td class="org-right">23</td>
<td class="org-right">2014-12</td>
<td class="org-right">134785</td>
</tr>
</tbody>
</table>
<p>
Perhaps not surprisingly, the month of December, when holiday sales spike, is the month with the most sales.
</p>
</div>
</div>
<div id="outline-container-orgecfa979" class="outline-3">
<h3 id="orgecfa979">Shop</h3>
<div class="outline-text-3" id="text-orgecfa979">
<div class="highlight"><pre><span></span>group = x_train.groupby(DataKeys.shop).sum().reset_index().sort_values(DataKeys.target)
</pre></div>


<div class="highlight"><pre><span></span>figure, axis = make_figure_and_axis("Shop", "Count", "Shop Sales For Total Time")
grid = seaborn.relplot(x=DataKeys.shop, y=DataKeys.target, data=group,
		       ax=axis)
</pre></div>

<p>
There appears to be seven or eight shops that dominate the sales.
</p>
</div>
</div>

<div id="outline-container-org6aa3a97" class="outline-3">
<h3 id="org6aa3a97">Item Category</h3>
<div class="outline-text-3" id="text-org6aa3a97">
<div class="highlight"><pre><span></span>group = x_train.groupby(DataKeys.item_category).sum().reset_index()
</pre></div>

<div class="highlight"><pre><span></span>figure, axis = make_figure_and_axis("Category", "Count", "Category Sales For Total Time")
grid = seaborn.relplot(x=DataKeys.item_category, y=DataKeys.target, data=group,
		       ax=axis)
</pre></div>

<p>
Some kind of weirdly coincidental linear relationship between the category ID and the total sales. 
</p>
</div>
</div>

<div id="outline-container-org324f441" class="outline-3">
<h3 id="org324f441">Biggest Over Time</h3>
<div class="outline-text-3" id="text-org324f441">
</div>
<div id="outline-container-org8b7d4d6" class="outline-4">
<h4 id="org8b7d4d6">Category</h4>
<div class="outline-text-4" id="text-org8b7d4d6">
<div class="highlight"><pre><span></span>category_group = x_train.groupby([DataKeys.date, DataKeys.item_category]).sum().reset_index()
biggest = category_group.iloc[category_group[DataKeys.target].idxmax()]
biggest_category = category_group[category_group.item_category_id == biggest.item_category_id]
figure, axis = make_figure_and_axis("Month", "Count", "Category {} Sales For Total Time".format(biggest[DataKeys.item_category]))
pyplot.xticks(rotation=45, ha="right")
grid = seaborn.relplot(x=DataKeys.date, y=DataKeys.target, data=biggest_category,
		       ax=axis, kind="line")
</pre></div>

<p>
Even the most popular item declines over time.
</p>

<div class="highlight"><pre><span></span>big = biggest_category[DataKeys.target]
big_max = big.max()
big_min = big.min()
difference = big_max - big_min
print("Max: {}".format(big_max))
print("Min: {}".format(big_min))
print("Difference: {}".format(difference))
print("Percent Decline: {:.1f} %".format(100 * (difference/big_max)))
</pre></div>

<p>
Max: 28987.0
Min: 5413.0
Difference: 23574.0
Percent Decline: 81.3 %
</p>
</div>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/preprocessing-the-kaggle-data/" class="u-url">Preprocessing the Kaggle Data</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/preprocessing-the-kaggle-data/" rel="bookmark"><time class="published dt-published" datetime="2018-08-25T13:05:56-07:00" title="2018-08-25 13:05">2018-08-25 13:05</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/preprocessing-the-kaggle-data/#orga1d2889">Introduction</a></li>
<li><a href="posts/preprocessing-the-kaggle-data/#orgc06b470">Tangle</a></li>
<li><a href="posts/preprocessing-the-kaggle-data/#org6d246d2">Imports</a></li>
<li><a href="posts/preprocessing-the-kaggle-data/#org7bbac33">Loading the Data</a></li>
<li><a href="posts/preprocessing-the-kaggle-data/#org2c6c201">Limit the Target Range</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga1d2889" class="outline-2">
<h2 id="orga1d2889">Introduction</h2>
<div class="outline-text-2" id="text-orga1d2889">
<p>
This is a post to do some basic pre-processing on the data. It won't do anything fancy (i.e. no Feature Engineering), but will just get the data ready to be used by the models. In particular, the rules say that the test data target will be limited to a range and the features are categorical so we need to transform them for non-tree models.
</p>
</div>
</div>
<div id="outline-container-orgc06b470" class="outline-2">
<h2 id="orgc06b470">Tangle</h2>
<div class="outline-text-2" id="text-orgc06b470">
<div class="highlight"><pre><span></span><span class="o">&lt;&lt;</span><span class="n">pypi</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">local</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">clip</span><span class="o">-</span><span class="n">it</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</div>
<div id="outline-container-org6d246d2" class="outline-2">
<h2 id="org6d246d2">Imports</h2>
<div class="outline-text-2" id="text-org6d246d2">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">"numpy.dtype size changed"</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">"numpy.ufunc size changed"</span><span class="p">)</span>
</pre></div>
</div>

<div id="outline-container-orgffa29da" class="outline-3">
<h3 id="orgffa29da">From pypi</h3>
<div class="outline-text-3" id="text-orgffa29da">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>

<div id="outline-container-org013409e" class="outline-3">
<h3 id="org013409e">This project</h3>
<div class="outline-text-3" id="text-org013409e">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kaggler.helpers.build_training_data</span> <span class="kn">import</span> <span class="n">Pickles</span>
<span class="kn">from</span> <span class="nn">kaggler.helpers.helpers</span> <span class="kn">import</span> <span class="n">Helpers</span>
</pre></div>
</div>
</div>
</div>
<div id="outline-container-org7bbac33" class="outline-2">
<h2 id="org7bbac33">Loading the Data</h2>
<div class="outline-text-2" id="text-org7bbac33">
<p>
This assumes you've run the <code>build_training_data.py</code> code to get the testing and training data sets. The <code>Helpers</code> class also expects a specific path, so you have to have the repository set up in <code>~/projects/kaggle-competitions/</code>.
</p>

<div class="highlight"><pre><span></span><span class="n">x_train</span> <span class="o">=</span> <span class="n">Helpers</span><span class="o">.</span><span class="n">unpickle</span><span class="p">(</span><span class="n">Pickles</span><span class="o">.</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">Helpers</span><span class="o">.</span><span class="n">unpickle</span><span class="p">(</span><span class="n">Pickles</span><span class="o">.</span><span class="n">x_test</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">Helpers</span><span class="o">.</span><span class="n">unpickle</span><span class="p">(</span><span class="n">Pickles</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">Helpers</span><span class="o">.</span><span class="n">unpickle</span><span class="p">(</span><span class="n">Pickles</span><span class="o">.</span><span class="n">y_test</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-org2c6c201" class="outline-2">
<h2 id="org2c6c201">Limit the Target Range</h2>
<div class="outline-text-2" id="text-org2c6c201">
<p>
According to the contest description the true target values are clipped to the <code>[0,20]</code> range, so it might make sense to clip the target data in our training and testing data to the given range.
</p>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">11</td>
<td class="org-right">15</td>
<td class="org-right">1324</td>
<td class="org-right">499</td>
<td class="org-right">55</td>
<td class="org-right">12</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">18</td>
<td class="org-right">31</td>
<td class="org-right">19981</td>
<td class="org-right">499</td>
<td class="org-right">43</td>
<td class="org-right">07</td>
<td class="org-right">2014</td>
</tr>
<tr>
<td class="org-right">32</td>
<td class="org-right">28</td>
<td class="org-right">7934</td>
<td class="org-right">398</td>
<td class="org-right">7</td>
<td class="org-right">09</td>
<td class="org-right">2015</td>
</tr>
<tr>
<td class="org-right">12</td>
<td class="org-right">43</td>
<td class="org-right">13518</td>
<td class="org-right">1499</td>
<td class="org-right">19</td>
<td class="org-right">01</td>
<td class="org-right">2014</td>
</tr>
<tr>
<td class="org-right">28</td>
<td class="org-right">25</td>
<td class="org-right">19927</td>
<td class="org-right">329</td>
<td class="org-right">57</td>
<td class="org-right">05</td>
<td class="org-right">2015</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>

<pre class="example">
count    1.287299e+06
mean     2.264775e+00
std      8.693074e+00
min     -2.200000e+01
25%      1.000000e+00
50%      1.000000e+00
75%      2.000000e+00
max      2.253000e+03
Name: item_count_month, dtype: float64

</pre>

<p>
Looking at the y-train data you can see that it ranges for -22 to 2,253 - so there is actually a huge amount of reduction in the range of the target data, but the median is only 1, so it might be that there are outliers in the data.
</p>

<div class="highlight"><pre><span></span><span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">axe</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Monthly Sales Distribution"</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Monthly Sales"</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="posts/preprocessing-the-kaggle-data/target_distribution.png" alt="target_distribution.png"></p>
</div>

<p>
It looks like the target is strongly right-skewed. So I guess it makes sense to <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.clip.html">clip</a> it.
</p>

<div class="highlight"><pre><span></span><span class="n">y_train_clipped</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">y_test_clipped</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y_train_clipped</span><span class="p">,</span> <span class="n">y_test_clipped</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">20</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">axe</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">y_train_clipped</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Monthly Sales Distribution Clipped"</span><span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Monthly Sales"</span><span class="p">)</span>
</pre></div>


<div class="figure">
<p><img src="posts/preprocessing-the-kaggle-data/y_train_clipped.png" alt="y_train_clipped.png"></p>
</div>

<p>
That actually didn't really fix the distribution, strangely.
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/building-the-training-set/" class="u-url">Building The Training Set</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="posts/building-the-training-set/" rel="bookmark"><time class="published dt-published" datetime="2018-08-25T09:31:43-07:00" title="2018-08-25 09:31">2018-08-25 09:31</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/building-the-training-set/#orge1f49f7">The Tangle</a></li>
<li><a href="posts/building-the-training-set/#org9d38200">Imports</a></li>
<li><a href="posts/building-the-training-set/#org49c8d6b">Helpers</a></li>
<li><a href="posts/building-the-training-set/#orgb7468d4">Building Up the Super Set</a></li>
<li><a href="posts/building-the-training-set/#orgbd920c1">Setting up the Training and Validation Data</a></li>
<li><a href="posts/building-the-training-set/#org9e67801">Creating the Validation Set</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge1f49f7" class="outline-2">
<h2 id="orge1f49f7">The Tangle</h2>
<div class="outline-text-2" id="text-orge1f49f7">
<p>
This is the exporter for stuff to be re-used outside of this post.
</p>
<div class="highlight"><pre><span></span><span class="o">&lt;&lt;</span><span class="n">python</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">suppress</span><span class="o">-</span><span class="n">warnings</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">pypi</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">local</span><span class="o">-</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">pickles</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="nb">super</span><span class="o">-</span><span class="nb">set</span><span class="o">-</span><span class="n">creator</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">data</span><span class="o">-</span><span class="n">source</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="nb">super</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">load</span><span class="o">-</span><span class="n">items</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="nb">super</span><span class="o">-</span><span class="n">duper</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="nb">super</span><span class="o">-</span><span class="n">dates</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">clean</span><span class="o">-</span><span class="nb">super</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">make</span><span class="o">-</span><span class="n">grouper</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">make</span><span class="o">-</span><span class="n">chunked</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="nb">super</span><span class="o">-</span><span class="n">group</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">merge</span><span class="o">-</span><span class="n">chunked</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">delete</span><span class="o">-</span><span class="n">day</span><span class="o">-</span><span class="n">count</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">targets</span><span class="o">-</span><span class="n">features</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">train</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">split</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
</div>

<div id="outline-container-org9d38200" class="outline-2">
<h2 id="org9d38200">Imports</h2>
<div class="outline-text-2" id="text-org9d38200">
</div>
<div id="outline-container-org79b14fc" class="outline-3">
<h3 id="org79b14fc">Python Standard Library</h3>
<div class="outline-text-3" id="text-org79b14fc">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>

<div id="outline-container-orgfa1827e" class="outline-3">
<h3 id="orgfa1827e">Suppressing the Numpy Warnings</h3>
<div class="outline-text-3" id="text-orgfa1827e">
<p>
This is to suppress the warnings when we import pandas.
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">"numpy.dtype size changed"</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">"numpy.ufunc size changed"</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-org5236dba" class="outline-3">
<h3 id="org5236dba">From pypi</h3>
<div class="outline-text-3" id="text-org5236dba">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>
</div>
</div>

<div id="outline-container-orgdd894ea" class="outline-3">
<h3 id="orgdd894ea">This Project</h3>
<div class="outline-text-3" id="text-orgdd894ea">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">kaggler.helpers.helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DataKeys</span><span class="p">,</span>
    <span class="n">DataNames</span><span class="p">,</span>
    <span class="n">DataSource</span><span class="p">,</span>
    <span class="n">Helpers</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-org49c8d6b" class="outline-2">
<h2 id="org49c8d6b">Helpers</h2>
<div class="outline-text-2" id="text-org49c8d6b">
</div>
<div id="outline-container-orgf09ce30" class="outline-3">
<h3 id="orgf09ce30">Pickles</h3>
<div class="outline-text-3" id="text-orgf09ce30">
<p>
I'm going to pickle the data to re-load them later so this will hold the names.
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Pickles</span><span class="p">:</span>
    <span class="sd">"""Holder of the pickle names"""</span>
    <span class="n">super_set</span> <span class="o">=</span> <span class="s2">"training_data"</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="s2">"grouped_months_data"</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="s2">"x_train"</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="s2">"x_test"</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="s2">"y_train"</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="s2">"y_test"</span>
    <span class="n">train_test</span> <span class="o">=</span> <span class="s2">"train_test"</span>
</pre></div>
</div>
</div>
</div>


<div id="outline-container-orgb7468d4" class="outline-2">
<h2 id="orgb7468d4">Building Up the Super Set</h2>
<div class="outline-text-2" id="text-orgb7468d4">
<p>
Since we have some variables in separate sets I thought it would be useful to combine them into a single training set.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SuperSet</span><span class="p">:</span>
    <span class="sd">"""Creates the super-set of data"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>
</pre></div>
</div>

<div id="outline-container-org5483960" class="outline-3">
<h3 id="org5483960">The Data Source</h3>
<div class="outline-text-3" id="text-org5483960">
<p>
I put the paths into a class called DataSource, this is just to instantiate it.
</p>

<div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""string-values for the data sources"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">()</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span>
</pre></div>
</div>
</div>

<div id="outline-container-org4931807" class="outline-3">
<h3 id="org4931807">Building the Super Set</h3>
<div class="outline-text-3" id="text-org4931807">
<p>
The <code>super_set</code> will be a combination of the different data-sources.
</p>

<div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""the super-set"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">data_sources</span><span class="o">.</span><span class="n">file_name_paths</span><span class="p">[</span><span class="n">DataNames</span><span class="o">.</span><span class="n">training</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">super_set</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-org2f8063e" class="outline-3">
<h3 id="org2f8063e">Adding the Category IDs</h3>
<div class="outline-text-3" id="text-org2f8063e">
<p>
The <code>items.csv</code> file holds a map of the item-ids to category-ids so we can <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.merge.html">merge</a> it in to get the category ids for our data-set.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Items</span><span class="p">:</span>
    <span class="sd">"""sale items data"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""a Data-Source object"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sources</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""dataframe of sale items"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data_sources</span><span class="o">.</span><span class="n">file_name_paths</span><span class="p">[</span><span class="n">DataNames</span><span class="o">.</span><span class="n">items</span><span class="p">])</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-left">item_name</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_category_id</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">! ВО ВЛАСТИ НАВАЖДЕНИЯ (ПЛАСТ.)         D</td>
<td class="org-right">0</td>
<td class="org-right">40</td>
</tr>
<tr>
<td class="org-left">!ABBYY FineReader 12 Professional Edition Full [PC, Цифровая версия]</td>
<td class="org-right">1</td>
<td class="org-right">76</td>
</tr>
<tr>
<td class="org-left">***В ЛУЧАХ СЛАВЫ   (UNV)                    D</td>
<td class="org-right">2</td>
<td class="org-right">40</td>
</tr>
<tr>
<td class="org-left">***ГОЛУБАЯ ВОЛНА  (Univ)                      D</td>
<td class="org-right">3</td>
<td class="org-right">40</td>
</tr>
<tr>
<td class="org-left">***КОРОБКА (СТЕКЛО)                       D</td>
<td class="org-right">4</td>
<td class="org-right">40</td>
</tr>
</tbody>
</table>
<p>
This is also going to add the name of the item, which I'm thinking won't be as useful, but we can clean that out later.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SuperDuper</span><span class="p">:</span>
    <span class="sd">"""super set with item counts"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">super_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""super-set of data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="o">=</span> <span class="n">SuperSet</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""sale-items data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">Items</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""super set with sale items"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">super_set</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
					      <span class="n">on</span><span class="o">=</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
					      <span class="n">how</span><span class="o">=</span><span class="s2">"left"</span><span class="p">)</span>

	    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">super_set</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">super_set</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-left">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_cnt_day</th>
<th scope="col" class="org-left">item_name</th>
<th scope="col" class="org-right">item_category_id</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">02.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">59</td>
<td class="org-right">22154</td>
<td class="org-right">999</td>
<td class="org-right">1</td>
<td class="org-left">ЯВЛЕНИЕ 2012 (BD)</td>
<td class="org-right">37</td>
</tr>
<tr>
<td class="org-right">03.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2552</td>
<td class="org-right">899</td>
<td class="org-right">1</td>
<td class="org-left">DEEP PURPLE  The House Of Blue Light  LP</td>
<td class="org-right">58</td>
</tr>
<tr>
<td class="org-right">05.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2552</td>
<td class="org-right">899</td>
<td class="org-right">-1</td>
<td class="org-left">DEEP PURPLE  The House Of Blue Light  LP</td>
<td class="org-right">58</td>
</tr>
<tr>
<td class="org-right">06.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2554</td>
<td class="org-right">1709.05</td>
<td class="org-right">1</td>
<td class="org-left">DEEP PURPLE  Who Do You Think We Are  LP</td>
<td class="org-right">58</td>
</tr>
<tr>
<td class="org-right">15.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2555</td>
<td class="org-right">1099</td>
<td class="org-right">1</td>
<td class="org-left">DEEP PURPLE 30 Very Best Of 2CD (Фирм.)</td>
<td class="org-right">56</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org4f96e40" class="outline-3">
<h3 id="org4f96e40">Splitting the Dates</h3>
<div class="outline-text-3" id="text-org4f96e40">
<p>
The <code>date</code> column has a string formatted <code>dd.mm.yy</code>. Since we want sales per month and it might change over time, I'll split the date-stamp up into day, month, and year (although I don't think I'll be keeping day).
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SuperDates</span><span class="p">:</span>
    <span class="sd">"""Super-set with dates split out"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_super_duper</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_date_expression</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_dates</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">super_duper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""A super-duper data set"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_duper</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_super_duper</span> <span class="o">=</span> <span class="n">SuperDuper</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_duper</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""regular expression to parse the dates"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_expression</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_date_expression</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">'(?P&lt;{}&gt;\d{{2}})\.'</span>
				     <span class="s1">'(?P&lt;{}&gt;\d{{2}})\.'</span>
				     <span class="s1">'(?P&lt;{}&gt;\d{{4}})'</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
					 <span class="n">DataKeys</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
					 <span class="n">DataKeys</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
					 <span class="n">DataKeys</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_expression</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""dataframe of dates"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dates</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">super_duper</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">date_expression</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dates</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""data set with date columns"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
		<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">super_duper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="p">),</span>
		<span class="n">axis</span><span class="o">=</span><span class="s1">'columns'</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"={}="</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date_expression</span><span class="p">))</span>
</pre></div>

<p>
<code>(?P&lt;day&gt;\d{2})\.(?P&lt;month&gt;\d{2})\.(?P&lt;year&gt;\d{4})</code>
</p>




<p>
Here's what <code>dates</code> looks like.
</p>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">day</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">02</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">03</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">05</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">06</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">15</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
</tbody>
</table>
<p>
Now we can smash our new data frame onto the transactions using the <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.concat.html">concat</a> function. By default it will try to add the rows from the second data frame to the rows of the first, but since we're adding new columns we need to pass in the <code>axis='columns'</code> argument.
</p>

<p>
Nowe we can see what our <code>super_set</code> looks like.
</p>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">super_set</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_cnt_day</th>
<th scope="col" class="org-left">item_name</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">day</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">02.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">59</td>
<td class="org-right">22154</td>
<td class="org-right">999</td>
<td class="org-right">1</td>
<td class="org-left">ЯВЛЕНИЕ 2012 (BD)</td>
<td class="org-right">37</td>
<td class="org-right">02</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">03.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2552</td>
<td class="org-right">899</td>
<td class="org-right">1</td>
<td class="org-left">DEEP PURPLE  The House Of Blue Light  LP</td>
<td class="org-right">58</td>
<td class="org-right">03</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">05.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2552</td>
<td class="org-right">899</td>
<td class="org-right">-1</td>
<td class="org-left">DEEP PURPLE  The House Of Blue Light  LP</td>
<td class="org-right">58</td>
<td class="org-right">05</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">06.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2554</td>
<td class="org-right">1709.05</td>
<td class="org-right">1</td>
<td class="org-left">DEEP PURPLE  Who Do You Think We Are  LP</td>
<td class="org-right">58</td>
<td class="org-right">06</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">15.01.2013</td>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2555</td>
<td class="org-right">1099</td>
<td class="org-right">1</td>
<td class="org-left">DEEP PURPLE 30 Very Best Of 2CD (Фирм.)</td>
<td class="org-right">56</td>
<td class="org-right">15</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgd772d6c" class="outline-3">
<h3 id="orgd772d6c">Cleaning Up</h3>
<div class="outline-text-3" id="text-orgd772d6c">
<p>
The <code>date</code> column is now superfluous, and I don't think we need the day, since we are predicting by month. I'm also going to assume that names aren't as useful as the numeric ids. This might not be true, but I think using the text would require pre-processing which is beyond what I'm doing here, so I'm going to leave them out (there is another file with shop names that needs to be loaded if the text turns out to be significant). I'm going to <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.drop.html">drop</a> the columns that I don't think I'll need.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SuperClean</span><span class="p">:</span>
    <span class="sd">"""The super-set data with extra columns removed"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="p">[</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">day</span><span class="p">]):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">drop</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">super_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""the super-set data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="o">=</span> <span class="n">SuperDates</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""The cleaned data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">super_set</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""Saves the data as a pickle"""</span>
	<span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">super_set</span><span class="p">)</span>
	<span class="k">return</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">super_set</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_cnt_day</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">59</td>
<td class="org-right">22154</td>
<td class="org-right">999</td>
<td class="org-right">1</td>
<td class="org-right">37</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2552</td>
<td class="org-right">899</td>
<td class="org-right">1</td>
<td class="org-right">58</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2552</td>
<td class="org-right">899</td>
<td class="org-right">-1</td>
<td class="org-right">58</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2554</td>
<td class="org-right">1709.05</td>
<td class="org-right">1</td>
<td class="org-right">58</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">25</td>
<td class="org-right">2555</td>
<td class="org-right">1099</td>
<td class="org-right">1</td>
<td class="org-right">56</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org9f069d7" class="outline-3">
<h3 id="org9f069d7">Saving the Super Set</h3>
<div class="outline-text-3" id="text-org9f069d7">
<p>
Now I'll pickle it up so it can be loaded later.
</p>


<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="n">super_set</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">super_set</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-orgbd920c1" class="outline-2">
<h2 id="orgbd920c1">Setting up the Training and Validation Data</h2>
<div class="outline-text-2" id="text-orgbd920c1">
<p>
Although I went through the trouble of smashing all the values into one Data Frame, it turns out that I need things grouped by month, and doing the grouping after adding the columns just make it messy, so I'm going to back-track a little here to set up the data we need for training and testing.
</p>
</div>

<div id="outline-container-orga1eed79" class="outline-3">
<h3 id="orga1eed79">The Grouper</h3>
<div class="outline-text-3" id="text-orga1eed79">
<p>
Since I'm going to aggregate by the month (really the <code>date_block_num</code>), leaving in things like the price doesn't really make sense so I'll make a sub-frame that I can <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.groupby.html">group</a>.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Grouper</span><span class="p">:</span>
    <span class="sd">"""Data Grouped by month, shop, item"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_cleaned</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_grouper</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cleaned</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""cleaned super-set"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleaned</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_cleaned</span> <span class="o">=</span> <span class="n">SuperClean</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleaned</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grouper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""goups the data by columns"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouper</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_grouper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span><span class="p">[[</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">date_block</span><span class="p">,</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">shop</span><span class="p">,</span>
					  <span class="n">DataKeys</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
					  <span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouper</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""the summed group-data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grouper</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">date_block</span><span class="p">,</span>
					       <span class="n">DataKeys</span><span class="o">.</span><span class="n">shop</span><span class="p">,</span>
					       <span class="n">DataKeys</span><span class="o">.</span><span class="n">item</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">grouped</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup><col class="org-right"></colgroup>
<thead><tr>
<th scope="col" class="org-right">item_cnt_day</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">6</td>
</tr>
<tr>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
<p>
The reason why it looks like we lost most of the data is that the <code>groupy</code> method moved the groups into the index.
</p>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>

<p>
                                item_cnt_day
date_block_num shop_id item_id              
0              0       32                6.0
                       33                3.0
                       35                1.0
                       43                1.0
                       51                2.0
</p>

<p>
So we're going to <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.reset_index.html">reset the index</a>, which will convert the <a href="https://pandas.pydata.org/pandas-docs/stable/advanced.html">multiindex</a> into columns. I'm also going to re-name the <code>item_cnt_day</code> column since it now represents the count for the whole month, not one day.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Chunked</span><span class="p">:</span>
    <span class="sd">"""Data set chunked-up to the months"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_grouped</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grouped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""grouped data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouped</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_grouped</span> <span class="o">=</span> <span class="n">Grouper</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouped</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""The chunked data with the counts renamed"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">grouped</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
		<span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span><span class="p">:</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span><span class="p">},</span>
		<span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">chunked</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_count_month</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">32</td>
<td class="org-right">6</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">33</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">35</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">43</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">51</td>
<td class="org-right">2</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orga76d5e6" class="outline-3">
<h3 id="orga76d5e6">Adding the Columns Back</h3>
<div class="outline-text-3" id="text-orga76d5e6">
</div>
<div id="outline-container-orge6f43ed" class="outline-4">
<h4 id="orge6f43ed">Group the Super Set</h4>
<div class="outline-text-4" id="text-orge6f43ed">
<p>
Back to the super-set. Since there are multiple entries for items in a given month, I'm going to group the items by shop and date-block (month) and then grab the last entry for each group. 
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SuperGroup</span><span class="p">:</span>
    <span class="sd">"""Super Set grouped</span>

<span class="sd">    Args:</span>
<span class="sd">     groups: list of columns to form the groups</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">date_block</span><span class="p">,</span>
			       <span class="n">DataKeys</span><span class="o">.</span><span class="n">shop</span><span class="p">,</span>
			       <span class="n">DataKeys</span><span class="o">.</span><span class="n">item</span><span class="p">]):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">super_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""cleaned super set of data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span> <span class="o">=</span> <span class="n">SuperClean</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_set</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""the super group data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">super_set</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">super_group</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_cnt_day</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">32</td>
<td class="org-right">221</td>
<td class="org-right">1</td>
<td class="org-right">40</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">33</td>
<td class="org-right">347</td>
<td class="org-right">1</td>
<td class="org-right">37</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">35</td>
<td class="org-right">247</td>
<td class="org-right">1</td>
<td class="org-right">40</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">43</td>
<td class="org-right">221</td>
<td class="org-right">1</td>
<td class="org-right">40</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">51</td>
<td class="org-right">127</td>
<td class="org-right">1</td>
<td class="org-right">57</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org727c764" class="outline-4">
<h4 id="org727c764">Re-add the missing columns</h4>
<div class="outline-text-4" id="text-org727c764">
<p>
Now we need to get the category id, price, etc, back into the grouped data by merging it with the de-duplicated one we just created.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MergeChunked</span><span class="p">:</span>
    <span class="sd">"""merge the super-set and the chunked data"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_super_group</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="n">Chunked</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">super_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_group</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_super_group</span> <span class="o">=</span> <span class="n">SuperGroup</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_super_group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">super_group</span><span class="p">,</span>
			<span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">date_block</span><span class="p">,</span>
			    <span class="n">DataKeys</span><span class="o">.</span><span class="n">shop</span><span class="p">,</span>
			    <span class="n">DataKeys</span><span class="o">.</span><span class="n">item</span><span class="p">],</span>
			<span class="n">how</span><span class="o">=</span><span class="s2">"left"</span><span class="p">)</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""save the data as a pickle"""</span>
	<span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">grouped</span><span class="p">)</span>
	<span class="k">return</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">Helpers</span><span class="o">.</span><span class="n">print_head</span><span class="p">(</span><span class="n">chunked</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
</colgroup>
<thead><tr>
<th scope="col" class="org-right">date_block_num</th>
<th scope="col" class="org-right">shop_id</th>
<th scope="col" class="org-right">item_id</th>
<th scope="col" class="org-right">item_count_month</th>
<th scope="col" class="org-right">item_price</th>
<th scope="col" class="org-right">item_cnt_day</th>
<th scope="col" class="org-right">item_category_id</th>
<th scope="col" class="org-right">month</th>
<th scope="col" class="org-right">year</th>
</tr></thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">32</td>
<td class="org-right">6</td>
<td class="org-right">221</td>
<td class="org-right">1</td>
<td class="org-right">40</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">33</td>
<td class="org-right">3</td>
<td class="org-right">347</td>
<td class="org-right">1</td>
<td class="org-right">37</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">35</td>
<td class="org-right">1</td>
<td class="org-right">247</td>
<td class="org-right">1</td>
<td class="org-right">40</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">43</td>
<td class="org-right">1</td>
<td class="org-right">221</td>
<td class="org-right">1</td>
<td class="org-right">40</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">51</td>
<td class="org-right">2</td>
<td class="org-right">127</td>
<td class="org-right">1</td>
<td class="org-right">57</td>
<td class="org-right">01</td>
<td class="org-right">2013</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org309a129" class="outline-4">
<h4 id="org309a129">Save the grouped-up data</h4>
<div class="outline-text-4" id="text-org309a129">
<p>
I'm calling it <code>grouped_months_data.pkl</code>, but since the name is in the <code>Pickles</code> class, I'll just have to remember to use <code>grouped</code>.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org9e67801" class="outline-2">
<h2 id="org9e67801">Creating the Validation Set</h2>
<div class="outline-text-2" id="text-org9e67801">
<p>
To make my validation and training set I'm going to use sklearn's <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html">train_test_split</a>. 
</p>
</div>
<div id="outline-container-orge0ce06a" class="outline-3">
<h3 id="orge0ce06a">Targets and Features</h3>
<div class="outline-text-3" id="text-orge0ce06a">
<p>
First we need to split the data up into inputs and targets
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrainValidation</span><span class="p">:</span>
    <span class="sd">"""Makes the training and validation sets</span>

<span class="sd">    Args:</span>
<span class="sd">     test_size: fraction of data to use as validaiton data</span>
<span class="sd">     seed: random seed</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">2018</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_x_test</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_y_train</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_y_test</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""the data chunked by month"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span> <span class="o">=</span> <span class="n">MergeChunked</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunked</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""the target data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked</span><span class="p">[</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""The feature data"""</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked</span><span class="p">[</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chunked</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
		    <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">chunked</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span><span class="p">,</span>
						<span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span><span class="p">])]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_test</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_test</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_train</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_train</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_test</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_test</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
	    <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span>
	    <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
	<span class="p">)</span>
	<span class="k">return</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""stores the data-files"""</span>
	<span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">x_train</span><span class="p">)</span>
	<span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">x_test</span><span class="p">)</span>
	<span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
	<span class="n">Helpers</span><span class="o">.</span><span class="n">pickle_it</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">Pickles</span><span class="o">.</span><span class="n">y_test</span><span class="p">)</span>
	<span class="k">return</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">"""checks the columns for the data"""</span>
	<span class="k">assert</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">"Features has target"</span>
	<span class="k">assert</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">"x_train has target"</span>
	<span class="k">assert</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">"x_test has target"</span>
	<span class="k">assert</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">"Features has day count"</span>
	<span class="k">assert</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">"x_train has day count"</span>
	<span class="k">assert</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">day_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">"x_test has day count"</span>
	<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span><span class="p">,</span> <span class="s2">"Target not month count"</span>
	<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span><span class="p">,</span> <span class="s2">"y-test not month count"</span>
	<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DataKeys</span><span class="o">.</span><span class="n">month_count</span><span class="p">,</span> <span class="s2">"y-train not month count"</span>
	<span class="k">return</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

<p>
(1609124,)
(1609124, 7)
</p>
</div>
</div>

<div id="outline-container-org872d1d2" class="outline-3">
<h3 id="org872d1d2">Make Like a Banana</h3>
<div class="outline-text-3" id="text-org872d1d2">
<p>
I'm going to create a training set with 80% of the data and leave the other 20% as the validation data.
</p>

<div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">TrainValidation</span><span class="p">()</span>
    <span class="n">data</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

<p>
(1287299, 7)
(321825, 7)
(1287299,)
(321825,)
</p>

<p>
So now we're set to get started.
</p>
</div>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-2.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
