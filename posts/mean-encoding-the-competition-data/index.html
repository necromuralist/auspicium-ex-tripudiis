<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Mean encoding applied to the competition data.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mean Encoding The Competition Data | Notes on Kaggle</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://necromuralist.github.io/Kaggle-Competitions/posts/mean-encoding-the-competition-data/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script><meta name="author" content="Cloistered Monkey">
<link rel="prev" href="../mean-encoding/" title="Mean Encoding" type="text/html">
<link rel="next" href="../predicting-the-mean/" title="Predicting the Mean" type="text/html">
<meta property="og:site_name" content="Notes on Kaggle">
<meta property="og:title" content="Mean Encoding The Competition Data">
<meta property="og:url" content="https://necromuralist.github.io/Kaggle-Competitions/posts/mean-encoding-the-competition-data/">
<meta property="og:description" content="Mean encoding applied to the competition data.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-09-23T18:50:28-07:00">
<meta property="article:tag" content="assignment competition encoding">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://necromuralist.github.io/Kaggle-Competitions/">

                <span id="blog-title">Notes on Kaggle</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="https://necromuralist.github.io/">The Cloistered Monkey</a>
                </li>
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- Google custom search --><form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="form-group">
<input type="text" name="q" class="form-control" placeholder="Search">
</div>
<button type="submit" class="btn btn-primary">
	<span class="glyphicon glyphicon-search"></span>
</button>
<input type="hidden" name="sitesearch" value="https://necromuralist.github.io/Kaggle-Competitions/">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.org" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Mean Encoding The Competition Data</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Cloistered Monkey
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2018-09-23T18:50:28-07:00" itemprop="datePublished" title="2018-09-23 18:50">2018-09-23 18:50</time></a></p>
            
        <p class="sourceline"><a href="index.org" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org87fc028">Introduction</a></li>
<li><a href="#org63f6b0f">General tips</a></li>
<li><a href="#orgd9abb4b">Read In the Data</a></li>
<li><a href="#org02fc65c">Aggregate data</a></li>
<li><a href="#org3f25deb">Mean encodings without regularization</a></li>
<li><a href="#orgcdaa0bf">Method 2</a></li>
<li><a href="#orgb7c5dbc">1. KFold scheme</a></li>
</ul>
</div>
</div>

<div id="outline-container-org87fc028" class="outline-2">
<h2 id="org87fc028">Introduction</h2>
<div class="outline-text-2" id="text-org87fc028">
<p>
In this programming assignment you will be working with the <i>1C</i> dataset from the final competition. You are asked to encode the <code>item_id</code> in 4 different ways:
</p>

<ol class="org-ol">
<li>Via KFold scheme;</li>
<li>Via Leave-one-out scheme;</li>
<li>Via smoothing scheme;</li>
<li>Via expanding mean scheme.</li>
</ol>
<p>
<b><b>You will need to submit</b></b> the correlation coefficient between the resulting encoding and the target variable up to 4 decimal places.
</p>
</div>
</div>

<div id="outline-container-org63f6b0f" class="outline-2">
<h2 id="org63f6b0f">General tips</h2>
<div class="outline-text-2" id="text-org63f6b0f">
<ul class="org-ul">
<li>Fill NANs in the encoding with <code>0.3343</code>.</li>
<li>Some encoding schemes depend on sorting order, so in order to avoid confusion, please use the following code snippet to construct the data frame. This snippet also implements mean encoding without regularization.</li>
</ul>
<div class="highlight"><pre><span></span># python standard library
from itertools import product

# pypi
import pandas
import numpy

# this course (github)
from hse_graders.assignment_3.grader import Grader

# this project
from kaggler.course.data import Data
</pre></div>
</div>
</div>

<div id="outline-container-orgd9abb4b" class="outline-2">
<h2 id="orgd9abb4b">Read In the Data</h2>
<div class="outline-text-2" id="text-orgd9abb4b">
<div class="highlight"><pre><span></span>sales = Data().sales_training_data
</pre></div>
</div>
</div>

<div id="outline-container-org02fc65c" class="outline-2">
<h2 id="org02fc65c">Aggregate data</h2>
<div class="outline-text-2" id="text-org02fc65c">
<p>
Since the competition task is to make a monthly prediction, we need to aggregate the data to montly level before doing any encodings. The following code-cell serves just that purpose.
</p>

<div class="highlight"><pre><span></span>index_cols = ['shop_id', 'item_id', 'date_block_num']
</pre></div>

<p>
For every month we create a grid from all shops/items combinations from that month.
</p>

<div class="highlight"><pre><span></span>grid = [] 
for block_num in sales['date_block_num'].unique():
    cur_shops = sales[sales['date_block_num']==block_num]['shop_id'].unique()
    cur_items = sales[sales['date_block_num']==block_num]['item_id'].unique()
    grid.append(numpy.array(list(product(*[cur_shops, cur_items, [block_num]])),dtype='int32'))
</pre></div>

<p>
Now turn the grid into a pandas dataframe.
</p>

<div class="highlight"><pre><span></span>grid = pandas.DataFrame(numpy.vstack(grid), columns = index_cols,dtype=numpy.int32)
</pre></div>


<p>
Get the aggregated values for (<code>shop_id</code>, <code>item_id</code>, and <code>month</code>).
</p>

<div class="highlight"><pre><span></span>grouped = sales.groupby(index_cols, as_index=False).agg({'item_cnt_day':{'target':'sum'}})
</pre></div>

<p>
Fix the column names.
</p>

<div class="highlight"><pre><span></span>grouped.columns = [column[0] if column[-1]=='' else column[-1] for column in grouped.columns.values]
</pre></div>

<p>
Join the aggregated data to the grid.
</p>

<div class="highlight"><pre><span></span>all_data = pandas.merge(grid, grouped, how='left', on=index_cols).fillna(0)
</pre></div>

<p>
Sort the data.
</p>

<div class="highlight"><pre><span></span>all_data.sort_values(['date_block_num','shop_id','item_id'], inplace=True)
</pre></div>
</div>
</div>

<div id="outline-container-org3f25deb" class="outline-2">
<h2 id="org3f25deb">Mean encodings without regularization</h2>
<div class="outline-text-2" id="text-org3f25deb">
<p>
Now that we have done the techinical work, we are ready to actually <b>mean encode</b> the desired <code>item_id</code> variable. 
</p>

<p>
Here are two ways to implement mean encoding features <b>without</b> any regularization. You can use this code as a starting point to implement regularized techniques. 
</p>
</div>

<div id="outline-container-orgc0f72a9" class="outline-3">
<h3 id="orgc0f72a9">Method 1:  Calculate a mapping: {item_id: target_mean}</h3>
<div class="outline-text-3" id="text-orgc0f72a9">
<div class="highlight"><pre><span></span>item_id_target_mean = all_data.groupby('item_id').target.mean()
</pre></div>

<p>
In our non-regularized case we just <b>map</b> the computed means to the <code>item_id</code>'s.
</p>

<div class="highlight"><pre><span></span>all_data['item_target_enc'] = all_data['item_id'].map(item_id_target_mean)
</pre></div>
</div>
</div>

<div id="outline-container-org7666e42" class="outline-3">
<h3 id="org7666e42">Fill NaNs</h3>
<div class="outline-text-3" id="text-org7666e42">
<div class="highlight"><pre><span></span>all_data['item_target_enc'].fillna(0.3343, inplace=True) 
</pre></div>
</div>
</div>

<div id="outline-container-org4790f2f" class="outline-3">
<h3 id="org4790f2f">Print correlation</h3>
<div class="outline-text-3" id="text-org4790f2f">
<div class="highlight"><pre><span></span>encoded_feature = all_data['item_target_enc'].values
print(numpy.corrcoef(all_data['target'].values, encoded_feature)[0][1])
</pre></div>

<p>
0.48303869886216977
</p>
</div>
</div>
</div>

<div id="outline-container-orgcdaa0bf" class="outline-2">
<h2 id="orgcdaa0bf">Method 2</h2>
<div class="outline-text-2" id="text-orgcdaa0bf">
<p>
Unlike the  <code>.target.mean()</code> function, <code>transform</code> will return a dataframe with an index like in <code>all_data</code>.
Basically this single line of code is equivalent to the first two lines from of Method 1.
</p>

<div class="highlight"><pre><span></span>all_data['item_target_enc'] = all_data.groupby('item_id')['target'].transform('mean')
</pre></div>
</div>

<div id="outline-container-orgbbba154" class="outline-3">
<h3 id="orgbbba154">Fill NaNs</h3>
<div class="outline-text-3" id="text-orgbbba154">
<div class="highlight"><pre><span></span>all_data['item_target_enc'].fillna(0.3343, inplace=True) 
</pre></div>
</div>
</div>

<div id="outline-container-orgccb2255" class="outline-3">
<h3 id="orgccb2255">Print correlation</h3>
<div class="outline-text-3" id="text-orgccb2255">
<div class="highlight"><pre><span></span>encoded_feature = all_data['item_target_enc'].values
print(numpy.corrcoef(all_data['target'].values, encoded_feature)[0][1])
</pre></div>

<p>
0.48303869886216977
</p>


<p>
See the printed value? It is the correlation coefficient between the target variable and your new encoded feature. You need to <b><b>compute the correlation coefficient</b></b> between the encodings that you will implement and <b><b>submit those to coursera</b></b>.
</p>

<div class="highlight"><pre><span></span>grader = Grader()
</pre></div>
</div>
</div>
</div>

<div id="outline-container-orgb7c5dbc" class="outline-2">
<h2 id="orgb7c5dbc">1. KFold scheme</h2>
<div class="outline-text-2" id="text-orgb7c5dbc">
<p>
This is Explained starting at 41 seconds into the <a href="https://www.coursera.org/learn/competitive-data-science/lecture/LGYQ2/regularization">Regularization lecture</a>.
</p>

<p>
First implement the KFold scheme with five folds. Use KFold(5) from sklearn.model_selection. 
</p>

<ol class="org-ol">
<li>Split your data in 5 folds with <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html">sklearn.model_selection.KFold</a> with <code>shuffle=False</code> (the default).</li>
<li>Iterate through folds: use all but the current fold to calculate mean target for each level `item_id`, and  fill the current fold.</li>
</ol>
<p>
See the <b><b>Method 1</b></b> from the example implementation. In particular learn what `map` and pd.Series.map functions do. They are pretty handy in many situations.
</p>


<p>
corr = np.corrcoef(all_data['target'].values, encoded_feature)[0][1]
print(corr)
grader.submit_tag('KFold_scheme', corr)
</p>


<p>
corr = np.corrcoef(all_data['target'].values, encoded_feature)[0][1]
print(corr)
grader.submit_tag('Leave-one-out_scheme', corr)
</p>


<p>
corr = np.corrcoef(all_data['target'].values, encoded_feature)[0][1]
print(corr)
grader.submit_tag('Smoothing_scheme', corr)
</p>


<p>
corr = np.corrcoef(all_data['target'].values, encoded_feature)[0][1]
print(corr)
grader.submit_tag('Expanding_mean_scheme', corr)
</p>


<p>
STUDENT_EMAIL = # EMAIL HERE
STUDENT_TOKEN = # TOKEN HERE
grader.status()
</p>


<p>
grader.submit(STUDENT_EMAIL, STUDENT_TOKEN)
</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/assignment-competition-encoding/" rel="tag">assignment competition encoding</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../mean-encoding/" rel="prev" title="Mean Encoding">Previous post</a>
            </li>
            <li class="next">
                <a href="../predicting-the-mean/" rel="next" title="Predicting the Mean">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
